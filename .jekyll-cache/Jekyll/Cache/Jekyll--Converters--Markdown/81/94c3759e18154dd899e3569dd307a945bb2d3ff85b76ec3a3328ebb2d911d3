I"ê<ul id="markdown-toc">
  <li><a href="#ä¸€é¢„å¤‡çŸ¥è¯†" id="markdown-toc-ä¸€é¢„å¤‡çŸ¥è¯†">ä¸€ã€é¢„å¤‡çŸ¥è¯†</a></li>
  <li><a href="#äºŒå®éªŒç¯å¢ƒ" id="markdown-toc-äºŒå®éªŒç¯å¢ƒ">äºŒã€å®éªŒç¯å¢ƒ</a></li>
  <li><a href="#ä¸‰malloc" id="markdown-toc-ä¸‰malloc">ä¸‰ã€malloc</a>    <ul>
      <li><a href="#æ²¡æœ‰mallocå°±æ²¡æœ‰å †" id="markdown-toc-æ²¡æœ‰mallocå°±æ²¡æœ‰å †">æ²¡æœ‰mallocå°±æ²¡æœ‰å †</a></li>
      <li><a href="#mallocx" id="markdown-toc-mallocx">malloc(x)</a></li>
    </ul>
  </li>
  <li><a href="#å››strace-brk-å’Œ-sbrk" id="markdown-toc-å››strace-brk-å’Œ-sbrk">å››ã€strace, brk å’Œ sbrk</a>    <ul>
      <li><a href="#å¤šæ¬¡malloc" id="markdown-toc-å¤šæ¬¡malloc">å¤šæ¬¡malloc</a></li>
      <li><a href="#è‡ªè¡Œå®ç°malloc" id="markdown-toc-è‡ªè¡Œå®ç°malloc">è‡ªè¡Œå®ç°malloc</a></li>
    </ul>
  </li>
  <li><a href="#äº”ä¸¢å¤±çš„16å­—èŠ‚" id="markdown-toc-äº”ä¸¢å¤±çš„16å­—èŠ‚">äº”ã€ä¸¢å¤±çš„16å­—èŠ‚</a>    <ul>
      <li><a href="#ä»æºç æ‰¾ç­”æ¡ˆrtfsc" id="markdown-toc-ä»æºç æ‰¾ç­”æ¡ˆrtfsc">ä»æºç æ‰¾ç­”æ¡ˆï¼ˆRTFSCï¼‰###</a></li>
    </ul>
  </li>
  <li><a href="#å…­å †çœŸçš„æ˜¯å‘ä¸Šç”Ÿé•¿å—" id="markdown-toc-å…­å †çœŸçš„æ˜¯å‘ä¸Šç”Ÿé•¿å—">å…­ã€å †çœŸçš„æ˜¯å‘ä¸Šç”Ÿé•¿å—</a></li>
  <li><a href="#ä¸ƒåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–aslr" id="markdown-toc-ä¸ƒåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–aslr">ä¸ƒã€åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–(ASLR)</a></li>
  <li><a href="#å…«è¿›ç¨‹åœ°å€ç©ºé—´ç¤ºæ„å›¾" id="markdown-toc-å…«è¿›ç¨‹åœ°å€ç©ºé—´ç¤ºæ„å›¾">å…«ã€è¿›ç¨‹åœ°å€ç©ºé—´ç¤ºæ„å›¾</a></li>
  <li><a href="#ä¹malloc0" id="markdown-toc-ä¹malloc0">ä¹ã€malloc(0)</a></li>
  <li><a href="#åç»“å°¾" id="markdown-toc-åç»“å°¾">åã€ç»“å°¾</a></li>
  <li><a href="#åä¸€ç»§ç»­é˜…è¯»" id="markdown-toc-åä¸€ç»§ç»­é˜…è¯»">åä¸€ã€ç»§ç»­é˜…è¯»</a></li>
  <li><a href="#åäºŒåŸæ–‡é“¾æ¥" id="markdown-toc-åäºŒåŸæ–‡é“¾æ¥">åäºŒã€åŸæ–‡é“¾æ¥</a></li>
</ul>
<p>è¿™æ˜¯è™šæ‹Ÿå†…å­˜ç³»åˆ—æ–‡ç« çš„ç¬¬å››ç¯‡ã€‚<br />
æœ¬æ–‡ä¸»è¦ä»‹ç»mallocå’Œheapç›¸å…³çŸ¥è¯†ï¼Œä»¥ä¾¿å›ç­”<a href="http://blog.coderhuo.tech/2017/10/16/Virtual_Memory_drawing_VM_diagram/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ç»“å°¾æå‡ºçš„ä¸€äº›é—®é¢˜:</p>

<ul>
  <li>åŠ¨æ€åˆ†é…çš„å†…å­˜ä¸ºä½•ä¸æ˜¯ä»å †çš„èµ·å§‹ä½ç½®<code class="highlighter-rouge">0x2050000</code>å¼€å§‹ï¼Œè€Œæ˜¯åç§»16ä¸ªå­—èŠ‚ä»<code class="highlighter-rouge">0x2050010</code>å¼€å§‹ï¼Ÿè¿™16ä¸ªå­—èŠ‚æ˜¯ä»€ä¹ˆç”¨é€”?</li>
  <li>å †çœŸçš„æ˜¯å‘ä¸Šç”Ÿé•¿çš„å—?</li>
</ul>

<h2 id="ä¸€é¢„å¤‡çŸ¥è¯†">ä¸€ã€é¢„å¤‡çŸ¥è¯†</h2>

<p>ä¸ºäº†æ–¹ä¾¿ç†è§£æœ¬æ–‡ï¼Œä½ éœ€è¦å…·å¤‡ä»¥ä¸‹çŸ¥è¯†ï¼š</p>

<ul>
  <li>Cè¯­è¨€åŸºç¡€(ç‰¹åˆ«æ˜¯æŒ‡é’ˆç›¸å…³çŸ¥è¯†)</li>
  <li>äº†è§£Linuxçš„æ–‡ä»¶ç³»ç»Ÿå’Œshellå‘½ä»¤</li>
  <li>äº†è§£æ–‡ä»¶<code class="highlighter-rouge">/proc/[pid]/maps</code>ï¼ˆå¯å‚é˜…<code class="highlighter-rouge">man proc</code>æˆ–<a href="http://blog.coderhuo.tech/2017/10/12/Virtual_Memory_C_strings_proc/">ã€Šè™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸€ç¯‡:C strings &amp; /procã€‹</a>ä¸­çš„ç›¸å…³ä»‹ç»ï¼‰</li>
</ul>

<h2 id="äºŒå®éªŒç¯å¢ƒ">äºŒã€å®éªŒç¯å¢ƒ</h2>
<p>æ‰€æœ‰çš„è„šæœ¬å’Œç¨‹åºéƒ½åœ¨ä¸‹é¢çš„ç¯å¢ƒä¸­æµ‹è¯•è¿‡ï¼š</p>

<ul>
  <li>Ubuntu
    <ul>
      <li>Linux ubuntu 4.4.0-31-generic #50~14.04.1-Ubuntu SMP Wed Jul 13 01:07:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</li>
    </ul>
  </li>
  <li>gcc
    <ul>
      <li>gcc (Ubuntu 4.8.4-2ubuntu1~14.04.3) 4.8.4</li>
    </ul>
  </li>
  <li>glibc 2.19</li>
  <li>strace (version 4.8)</li>
</ul>

<p><strong>ä¸‹é¢æåˆ°çš„éƒ½æ˜¯åŸºäºæœ¬ç³»ç»Ÿçš„ï¼Œå…¶ä»–ç³»ç»Ÿå¯èƒ½ä¼šæœ‰å·®å¼‚ã€‚</strong></p>

<p>æˆ‘ä»¬ä¼šæŸ¥çœ‹éƒ¨åˆ†Linuxå†…æ ¸æºç ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯Ubuntuç³»ç»Ÿï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸æºç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get source linux-image-$(uname -r)
</code></pre></div></div>

<h2 id="ä¸‰malloc">ä¸‰ã€malloc</h2>

<p><code class="highlighter-rouge">malloc</code>æ˜¯åŠ¨æ€åˆ†é…å†…å­˜å¸¸ç”¨å‡½æ•°ï¼Œå®ƒåˆ†é…çš„å†…å­˜åœ¨å †ä¸Šã€‚</p>

<p><em>æç¤º:<code class="highlighter-rouge">malloc</code>ä¸æ˜¯ç³»ç»Ÿå‡½æ•°ã€‚</em></p>

<p>ä»<code class="highlighter-rouge">man malloc</code>çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[...] allocate dynamic memory[...]
void *malloc(size_t size);
[...]
The malloc() function allocates size bytes and returns a pointer to the allocated memory.
</code></pre></div></div>

<h3 id="æ²¡æœ‰mallocå°±æ²¡æœ‰å †">æ²¡æœ‰mallocå°±æ²¡æœ‰å †</h3>

<p>æˆ‘ä»¬è§‚å¯Ÿä¸€ä¸ªæ²¡æœ‰è°ƒç”¨<code class="highlighter-rouge">malloc</code>çš„è¿›ç¨‹çš„å†…å­˜åˆ†å¸ƒæƒ…å†µ:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdlib.h&gt;
#include &lt;stdio.h&gt;

/**
 * main - do nothing
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    getchar();
    return (EXIT_SUCCESS);
}
</code></pre></div></div>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 0-main.c -o 0
julien@holberton:~/holberton/w/hackthevm3$ ./0 
</code></pre></div></div>

<p><em>æç¤ºï¼šè¿›ç¨‹çš„å†…å­˜åˆ†å¸ƒæƒ…å†µåœ¨æ–‡ä»¶<code class="highlighter-rouge">/proc/[pid]/maps</code>æ–‡ä»¶ä¸­ã€‚ä¸ºäº†æŸ¥çœ‹è¯¥æ–‡ä»¶ï¼Œ æˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“è¿›ç¨‹çš„PIDã€‚å¯ä»¥é€šè¿‡å‘½ä»¤<code class="highlighter-rouge">ps</code>æŸ¥çœ‹è¿›ç¨‹IDã€‚<code class="highlighter-rouge">ps aux</code>è¾“å‡ºçš„ç¬¬äºŒåˆ—å°±æ˜¯è¿›ç¨‹çš„PIDï¼Œå…·ä½“å¯å‚é˜…<a href="http://blog.coderhuo.tech/2017/10/12/Virtual_Memory_C_strings_proc/">ã€Šè™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸€ç¯‡:C strings &amp; /procã€‹</a>ä¸­çš„ç›¸å…³ä»‹ç»ã€‚</em></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/tmp$ ps aux | grep \ \./0$
julien     3638  0.0  0.0   4200   648 pts/9    S+   12:01   0:00 ./0
</code></pre></div></div>
<p><em>æç¤ºï¼šä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¦æ‰¾çš„è¿›ç¨‹çš„idæ˜¯<code class="highlighter-rouge">3638</code>ï¼Œå› æ­¤ï¼Œæ–‡ä»¶<code class="highlighter-rouge">maps</code>ä½äºæ–‡ä»¶å¤¹`/proc/3638ä¸‹é¢ã€‚</em></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/tmp$ cd /proc/3638
</code></pre></div></div>

<p><em>æç¤ºï¼šæ–‡ä»¶<code class="highlighter-rouge">maps</code>åŒ…å«è¿›ç¨‹çš„å†…å­˜åˆ†å¸ƒå›¾ï¼Œæ¯ä¸€è¡Œçš„æ ¼å¼å¦‚ä¸‹ï¼š
<code class="highlighter-rouge">address perms offset dev inode pathname</code></em></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/3638$ cat maps
00400000-00401000 r-xp 00000000 08:01 174583                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/0
00600000-00601000 r--p 00000000 08:01 174583                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/0
00601000-00602000 rw-p 00001000 08:01 174583                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/0
7f38f87d7000-7f38f8991000 r-xp 00000000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f38f8991000-7f38f8b91000 ---p 001ba000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f38f8b91000-7f38f8b95000 r--p 001ba000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f38f8b95000-7f38f8b97000 rw-p 001be000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f38f8b97000-7f38f8b9c000 rw-p 00000000 00:00 0 
7f38f8b9c000-7f38f8bbf000 r-xp 00000000 08:01 136229                     /lib/x86_64-linux-gnu/ld-2.19.so
7f38f8da3000-7f38f8da6000 rw-p 00000000 00:00 0 
7f38f8dbb000-7f38f8dbe000 rw-p 00000000 00:00 0 
7f38f8dbe000-7f38f8dbf000 r--p 00022000 08:01 136229                     /lib/x86_64-linux-gnu/ld-2.19.so
7f38f8dbf000-7f38f8dc0000 rw-p 00023000 08:01 136229                     /lib/x86_64-linux-gnu/ld-2.19.so
7f38f8dc0000-7f38f8dc1000 rw-p 00000000 00:00 0 
7ffdd85c5000-7ffdd85e6000 rw-p 00000000 00:00 0                          [stack]
7ffdd85f2000-7ffdd85f4000 r--p 00000000 00:00 0                          [vvar]
7ffdd85f4000-7ffdd85f6000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
julien@holberton:/proc/3638$ 
</code></pre></div></div>

<p><em>æ³¨æ„ï¼š<code class="highlighter-rouge">hackthevm3</code> æ˜¯ <code class="highlighter-rouge">hack_the_virtual_memory/03. The Heap/</code>çš„ç¬¦å·é“¾æ¥ï¼Œå¤§å®¶ä¸è¦è¢«è¯¯å¯¼äº†ã€‚</em></p>

<p>ä»ä¸Šé¢çš„<code class="highlighter-rouge">maps</code>æ–‡ä»¶å¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰å †([heap])æ®µã€‚</p>

<h3 id="mallocx">malloc(x)</h3>

<p>æˆ‘ä»¬çœ‹çœ‹å¦ä¸€ä¸ªè°ƒç”¨<code class="highlighter-rouge">malloc</code>çš„ç¨‹åº(<code class="highlighter-rouge">1-main.c</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

/**
 * main - 1 call to malloc
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    malloc(1);
    getchar();
    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œ:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 1-main.c -o 1
julien@holberton:~/holberton/w/hackthevm3$ ./1 
</code></pre></div></div>
<p>æŸ¥çœ‹<code class="highlighter-rouge">maps</code>æ–‡ä»¶:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/3638$ ps aux | grep \ \./1$
julien     3718  0.0  0.0   4332   660 pts/9    S+   12:09   0:00 ./1
julien@holberton:/proc/3638$ cd /proc/3718
julien@holberton:/proc/3718$ cat maps 
00400000-00401000 r-xp 00000000 08:01 176964                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/1
00600000-00601000 r--p 00000000 08:01 176964                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/1
00601000-00602000 rw-p 00001000 08:01 176964                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/1
01195000-011b6000 rw-p 00000000 00:00 0                                  [heap]
...
julien@holberton:/proc/3718$ 
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°, è¿™æ¬¡æœ‰å †æ®µã€‚</p>

<p>æˆ‘ä»¬æ£€æŸ¥ä¸‹<code class="highlighter-rouge">malloc</code>çš„è¿”å›å€¼, çœ‹çœ‹è¯¥åœ°å€æ˜¯ä¸æ˜¯çœŸçš„åœ¨å †ä¸Š(<code class="highlighter-rouge">2-main.c</code>)ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

/**
 * main - prints the malloc returned address
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;

    p = malloc(1);
    printf("%p\n", p);
    getchar();
    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œ:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 2-main.c -o 2
julien@holberton:~/holberton/w/hackthevm3$ ./2 
0x24d6010
</code></pre></div></div>

<p>æŸ¥çœ‹<code class="highlighter-rouge">maps</code>æ–‡ä»¶:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/3718$ ps aux | grep \ \./2$
julien     3834  0.0  0.0   4336   676 pts/9    S+   12:48   0:00 ./2
julien@holberton:/proc/3718$ cd /proc/3834
julien@holberton:/proc/3834$ cat maps
00400000-00401000 r-xp 00000000 08:01 176966                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/2
00600000-00601000 r--p 00000000 08:01 176966                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/2
00601000-00602000 rw-p 00001000 08:01 176966                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/2
024d6000-024f7000 rw-p 00000000 00:00 0                                  [heap]
...
julien@holberton:/proc/3834$ 
</code></pre></div></div>
<p>å¯ä»¥çœ‹åˆ°: <code class="highlighter-rouge">024d6000</code> &lt; <code class="highlighter-rouge">0x24d6010</code> &lt; <code class="highlighter-rouge">024f7000</code>ï¼Œ å› æ­¤<code class="highlighter-rouge">malloc</code>è¿”å›çš„å†…å­˜åœ°å€æ˜¯åœ¨å †ä¸Šçš„ã€‚</p>

<p>å¦å¤–, å’Œ<a href="http://blog.coderhuo.tech/2017/10/16/Virtual_Memory_drawing_VM_diagram/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­çœ‹åˆ°çš„ä¸€æ ·ï¼Œåœ°å€å¹¶æœªä»å †çš„èµ·å§‹åœ°å€(<code class="highlighter-rouge">024d6000</code>)å¼€å§‹åˆ†é…ï¼Œè€Œæ˜¯åç§»äº†<code class="highlighter-rouge">16</code>ä¸ªå­—èŠ‚ï¼Œä»<code class="highlighter-rouge">0x24d6010</code>å¼€å§‹ã€‚æˆ‘ä»¬åé¢å†è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚</p>

<h2 id="å››strace-brk-å’Œ-sbrk">å››ã€strace, brk å’Œ sbrk</h2>

<p><code class="highlighter-rouge">malloc</code>æ˜¯ä¸ªå¸¸è§„å‡½æ•°ï¼ˆç›¸å¯¹äºç³»ç»Ÿå‡½æ•°è€Œè¨€ï¼‰ï¼Œä¸ºäº†æ“ä½œå †ï¼Œå®ƒå¿…é¡»è°ƒç”¨å…¶ä»–çš„ç³»ç»Ÿå‡½æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨<code class="highlighter-rouge">strace</code>æ¥å¯»æ‰¾è¿™ä¸ªè¢«<code class="highlighter-rouge">malloc</code>è°ƒç”¨çš„ç³»ç»Ÿå‡½æ•°ã€‚</p>

<p><code class="highlighter-rouge">strace</code>ç”¨æ¥è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨å’Œä¿¡å·ã€‚æ¯ä¸ªç¨‹åºåœ¨æ‰§è¡Œ<code class="highlighter-rouge">main</code>å‡½æ•°å‰éƒ½ä¼šè°ƒç”¨ä¸€äº›ç³»ç»Ÿå‡½æ•°ã€‚ä¸ºäº†æ–¹ä¾¿æ‰¾åˆ°<code class="highlighter-rouge">malloc</code>ä½¿ç”¨çš„æ˜¯å“ªä¸ªç³»ç»Ÿå‡½æ•°ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨<code class="highlighter-rouge">malloc</code>çš„ä»£ç å‰åéƒ½åŠ ä¸Šäº†ç³»ç»Ÿè°ƒç”¨<code class="highlighter-rouge">write</code>(<code class="highlighter-rouge">3-main.c</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**
 * main - let's find out which syscall malloc is using
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;

    write(1, "BEFORE MALLOC\n", 14);
    p = malloc(1);
    write(1, "AFTER MALLOC\n", 13);
    printf("%p\n", p);
    getchar();
    return (EXIT_SUCCESS);
}
</code></pre></div></div>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 3-main.c -o 3
julien@holberton:~/holberton/w/hackthevm3$ strace ./3 
execve("./3", ["./3"], [/* 61 vars */]) = 0
...
write(1, "BEFORE MALLOC\n", 14BEFORE MALLOC
)         = 14
brk(0)                                  = 0xe70000
brk(0xe91000)                           = 0xe91000
write(1, "AFTER MALLOC\n", 13AFTER MALLOC
)          = 13
...
read(0, 
</code></pre></div></div>
<p>å¯ä»¥çœ‹å‡ºï¼Œ<code class="highlighter-rouge">malloc</code>è°ƒç”¨ç³»ç»Ÿå‡½æ•°<code class="highlighter-rouge">brk</code>æ¥æ“ä½œå †ã€‚ä»<code class="highlighter-rouge">man brk</code>å¯ä»¥çœ‹åˆ°è¯¥ç³»ç»Ÿå‡½æ•°çš„ä»‹ç»ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
       int brk(void *addr);
       void *sbrk(intptr_t increment);
...
DESCRIPTION
       brk() and sbrk() change the location of the program  break,  which  defines
       the end of the process's data segment (i.e., the program break is the first
       location after the end of the uninitialized data segment).  Increasing  the
       program  break has the effect of allocating memory to the process; decreasâ€
       ing the break deallocates memory.

       brk() sets the end of the data segment to the value specified by addr, when
       that  value  is  reasonable,  the system has enough memory, and the process
       does not exceed its maximum data size (see setrlimit(2)).

       sbrk() increments the program's data space  by  increment  bytes.   Calling
       sbrk()  with  an increment of 0 can be used to find the current location of
       the program break.
</code></pre></div></div>

<p><code class="highlighter-rouge">program break</code>æ˜¯è™šæ‹Ÿå†…å­˜ä¸­æ•°æ®æ®µçš„ç»“æŸä½ç½®ï¼Œ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/program-break-before.png" alt="" /></p>

<p><code class="highlighter-rouge">malloc</code>é€šè¿‡è°ƒç”¨<code class="highlighter-rouge">brk</code>æˆ–<code class="highlighter-rouge">sbrk</code>å¢åŠ <code class="highlighter-rouge">program break</code>çš„å€¼ï¼Œä»è€Œåˆ›å»ºå¯ä»¥é€šè¿‡<code class="highlighter-rouge">malloc</code>åŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥å †æ˜¯è¿›ç¨‹çš„æ•°æ®æ®µçš„å»¶ä¼¸ã€‚<br />
<img src="http://data.coderhuo.tech/blog/virtual_memory/program-break-after.png" alt="" /></p>

<p>ä¸Šé¢ç¤ºä¾‹ä¸­é¦–æ¬¡è°ƒç”¨<code class="highlighter-rouge">brk</code>(<code class="highlighter-rouge">brk(0)</code>)è¿”å›çš„æ˜¯<code class="highlighter-rouge">program break</code>çš„å½“å‰åœ°å€ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨åˆ™é€šè¿‡ç§»åŠ¨<code class="highlighter-rouge">program break</code>çš„ä½ç½®å¢åŠ äº†å†…å­˜ç©ºé—´(ä»<code class="highlighter-rouge">0xe70000</code> åˆ° <code class="highlighter-rouge">0xe91000</code>)ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå †æ®µèµ·å§‹äº<code class="highlighter-rouge">0xe70000</code>ï¼Œ ç»“æŸäº<code class="highlighter-rouge">0xe91000</code>ã€‚æˆ‘ä»¬çœ‹ä¸‹<code class="highlighter-rouge">/proc/[pid]/maps</code>æ–‡ä»¶,æ˜¯å¦çœŸçš„å¦‚æ­¤ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/3855$ ps aux | grep \ \./3$
julien     4011  0.0  0.0   4748   708 pts/9    S+   13:04   0:00 strace ./3
julien     4014  0.0  0.0   4336   644 pts/9    S+   13:04   0:00 ./3
julien@holberton:/proc/3855$ cd /proc/4014
julien@holberton:/proc/4014$ cat maps 
00400000-00401000 r-xp 00000000 08:01 176967                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/3
00600000-00601000 r--p 00000000 08:01 176967                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/3
00601000-00602000 rw-p 00001000 08:01 176967                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/3
00e70000-00e91000 rw-p 00000000 00:00 0                                  [heap]
...
julien@holberton:/proc/4014$ 
</code></pre></div></div>

<p>å †æ®µå¦‚ä¸‹ï¼Œå’Œ<code class="highlighter-rouge">brk</code>çš„è¿”å›å€¼ä¸€è‡´ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00e70000-00e91000 rw-p 00000000 00:00 0 [heap]
</code></pre></div></div>

<p>ä½†æ˜¯ä»£ç ä¸­æˆ‘ä»¬åªéœ€è¦1ä¸ªå­—èŠ‚ï¼Œä¸ºä»€ä¹ˆ<code class="highlighter-rouge">malloc</code>ä¸€ä¸‹å­æŠŠå †å¢åŠ äº†è¿™ä¹ˆå¤šï¼ˆ<code class="highlighter-rouge">00e91000</code> â€“ <code class="highlighter-rouge">00e70000</code> = <code class="highlighter-rouge">0x21000</code> ï¼Œä¹Ÿå°±æ˜¯135168å­—èŠ‚ï¼‰ï¼Ÿ</p>

<h3 id="å¤šæ¬¡malloc">å¤šæ¬¡malloc</h3>
<p>å¦‚æœæˆ‘ä»¬å¤šæ¬¡è°ƒç”¨<code class="highlighter-rouge">malloc</code>å°†ä¼šæ€ä¹ˆæ ·å‘¢(<code class="highlighter-rouge">4-main.c</code>)ï¼Ÿ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**
 * main - many calls to malloc
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;

    write(1, "BEFORE MALLOC #0\n", 17);
    p = malloc(1024);
    write(1, "AFTER MALLOC #0\n", 16);
    printf("%p\n", p);

    write(1, "BEFORE MALLOC #1\n", 17);
    p = malloc(1024);
    write(1, "AFTER MALLOC #1\n", 16);
    printf("%p\n", p);

    write(1, "BEFORE MALLOC #2\n", 17);
    p = malloc(1024);
    write(1, "AFTER MALLOC #2\n", 16);
    printf("%p\n", p);

    write(1, "BEFORE MALLOC #3\n", 17);
    p = malloc(1024);
    write(1, "AFTER MALLOC #3\n", 16);
    printf("%p\n", p);

    getchar();
    return (EXIT_SUCCESS);
}
</code></pre></div></div>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 4-main.c -o 4
julien@holberton:~/holberton/w/hackthevm3$ strace ./4 
execve("./4", ["./4"], [/* 61 vars */]) = 0
...
write(1, "BEFORE MALLOC #0\n", 17BEFORE MALLOC #0
)      = 17
brk(0)                                  = 0x1314000
brk(0x1335000)                          = 0x1335000
write(1, "AFTER MALLOC #0\n", 16AFTER MALLOC #0
)       = 16
...
write(1, "0x1314010\n", 100x1314010
)             = 10
write(1, "BEFORE MALLOC #1\n", 17BEFORE MALLOC #1
)      = 17
write(1, "AFTER MALLOC #1\n", 16AFTER MALLOC #1
)       = 16
write(1, "0x1314420\n", 100x1314420
)             = 10
write(1, "BEFORE MALLOC #2\n", 17BEFORE MALLOC #2
)      = 17
write(1, "AFTER MALLOC #2\n", 16AFTER MALLOC #2
)       = 16
write(1, "0x1314830\n", 100x1314830
)             = 10
write(1, "BEFORE MALLOC #3\n", 17BEFORE MALLOC #3
)      = 17
write(1, "AFTER MALLOC #3\n", 16AFTER MALLOC #3
)       = 16
write(1, "0x1314c40\n", 100x1314c40
)             = 10
...
read(0, 
</code></pre></div></div>

<p>ä»ä¸Šé¢<code class="highlighter-rouge">strace</code>è·Ÿè¸ªç»“æœå¯ä»¥çœ‹å‡ºï¼Œ<code class="highlighter-rouge">malloc</code>å¹¶æ²¡æœ‰æ¯æ¬¡éƒ½è°ƒç”¨ç³»ç»Ÿå‡½æ•°<code class="highlighter-rouge">brk</code>ã€‚</p>

<p>ç¬¬ä¸€æ¬¡è°ƒç”¨<code class="highlighter-rouge">malloc</code>çš„æ—¶å€™ï¼Œ<code class="highlighter-rouge">malloc</code>é€šè¿‡æ”¹å˜<code class="highlighter-rouge">program break</code>çš„ä½ç½®å¢åŠ äº†å †çš„å¤§å°ã€‚æ¥ä¸‹æ¥çš„è°ƒç”¨ï¼Œ<code class="highlighter-rouge">malloc</code>ä»…ä»…åœ¨ç°æœ‰çš„å †ä¸Šç»™æˆ‘ä»¬åˆ†é…å†…å­˜ï¼Œè¿™äº›æ–°åˆ†é…çš„å†…å­˜éƒ½æ˜¯é¦–æ¬¡è°ƒç”¨	<code class="highlighter-rouge">malloc</code>çš„æ—¶å€™é€šè¿‡<code class="highlighter-rouge">brk</code>åˆ†é…çš„ã€‚è¿™æ ·çš„è¯ï¼Œ<code class="highlighter-rouge">malloc</code>å°±ä¸å¿…æ¯æ¬¡éƒ½è°ƒç”¨ç³»ç»Ÿå‡½æ•°<code class="highlighter-rouge">brk</code>ï¼Œä¹Ÿå°±æå‡äº†<code class="highlighter-rouge">malloc</code>çš„æ‰§è¡Œé€Ÿåº¦, è¿›è€Œæé«˜äº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦ã€‚å¦å¤–ï¼Œè¿™ä¹Ÿæœ‰åŠ©äºå‡½æ•°<code class="highlighter-rouge">malloc</code>å’Œ<code class="highlighter-rouge">free</code>ä¼˜åŒ–å†…å­˜çš„ä½¿ç”¨ã€‚</p>

<p>æˆ‘ä»¬é€šè¿‡<code class="highlighter-rouge">maps</code>æ–‡ä»¶ç¡®è®¤ä¸‹æ˜¯ä¸æ˜¯åªæœ‰ä¸€ä¸ªå †(é¦–æ¬¡è°ƒç”¨<code class="highlighter-rouge">brk</code>åˆ†é…çš„)ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/4014$ ps aux | grep \ \./4$
julien     4169  0.0  0.0   4748   688 pts/9    S+   13:33   0:00 strace ./4
julien     4172  0.0  0.0   4336   656 pts/9    S+   13:33   0:00 ./4
julien@holberton:/proc/4014$ cd /proc/4172
julien@holberton:/proc/4172$ cat maps
00400000-00401000 r-xp 00000000 08:01 176973                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/4
00600000-00601000 r--p 00000000 08:01 176973                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/4
00601000-00602000 rw-p 00001000 08:01 176973                             /home/julien/holberton/w/hack_the_virtual_memory/03. The Heap/4
01314000-01335000 rw-p 00000000 00:00 0                                  [heap]
7f4a3f2c4000-7f4a3f47e000 r-xp 00000000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f4a3f47e000-7f4a3f67e000 ---p 001ba000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f4a3f67e000-7f4a3f682000 r--p 001ba000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f4a3f682000-7f4a3f684000 rw-p 001be000 08:01 136253                     /lib/x86_64-linux-gnu/libc-2.19.so
7f4a3f684000-7f4a3f689000 rw-p 00000000 00:00 0 
7f4a3f689000-7f4a3f6ac000 r-xp 00000000 08:01 136229                     /lib/x86_64-linux-gnu/ld-2.19.so
7f4a3f890000-7f4a3f893000 rw-p 00000000 00:00 0 
7f4a3f8a7000-7f4a3f8ab000 rw-p 00000000 00:00 0 
7f4a3f8ab000-7f4a3f8ac000 r--p 00022000 08:01 136229                     /lib/x86_64-linux-gnu/ld-2.19.so
7f4a3f8ac000-7f4a3f8ad000 rw-p 00023000 08:01 136229                     /lib/x86_64-linux-gnu/ld-2.19.so
7f4a3f8ad000-7f4a3f8ae000 rw-p 00000000 00:00 0 
7ffd1ba73000-7ffd1ba94000 rw-p 00000000 00:00 0                          [stack]
7ffd1bbed000-7ffd1bbef000 r--p 00000000 00:00 0                          [vvar]
7ffd1bbef000-7ffd1bbf1000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
julien@holberton:/proc/4172$ 
</code></pre></div></div>

<p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªå †ï¼Œå®ƒçš„åœ°å€å’Œ<code class="highlighter-rouge">brk</code>çš„è¿”å›å€¼(<code class="highlighter-rouge">0x1314000</code> &amp; <code class="highlighter-rouge">0x1335000</code>)æ˜¯ä¸€è‡´çš„ã€‚</p>

<h3 id="è‡ªè¡Œå®ç°malloc">è‡ªè¡Œå®ç°malloc</h3>
<p>æ ¹æ®ä¸Šé¢å­¦åˆ°çš„çŸ¥è¯†ï¼Œå‡è®¾æˆ‘ä»¬ä¸éœ€è¦é‡Šæ”¾å†…å­˜ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™è‡ªå·±çš„<code class="highlighter-rouge">malloc</code>å‡½æ•°ã€‚å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œè¿™ä¸ª<code class="highlighter-rouge">malloc</code>æ¯æ¬¡éƒ½ç§»åŠ¨<code class="highlighter-rouge">program break</code>çš„ä½ç½®ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**                                                                                            
 * malloc - naive version of malloc: dynamically allocates memory on the heap using sbrk                         
 * @size: number of bytes to allocate                                                          
 *                                                                                             
 * Return: the memory address newly allocated, or NULL on error                                
 *                                                                                             
 * Note: don't do this at home :)                                                              
 */
void *malloc(size_t size)
{
    void *previous_break;

    previous_break = sbrk(size);
    /* check for error */
    if (previous_break == (void *) -1)
    {
        /* on error malloc returns NULL */
        return (NULL);
    }
    return (previous_break);
}
</code></pre></div></div>

<h2 id="äº”ä¸¢å¤±çš„16å­—èŠ‚">äº”ã€ä¸¢å¤±çš„16å­—èŠ‚</h2>

<p>ä»ä¸Šé¢ç¨‹åº(<code class="highlighter-rouge">4-main.c</code>)çš„è¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼Œé¦–æ¬¡è°ƒç”¨<code class="highlighter-rouge">malloc</code>è¿”å›çš„åœ°å€ï¼ˆ<code class="highlighter-rouge">0x1314010</code>ï¼‰å¹¶ä¸æ˜¯å †çš„èµ·å§‹åœ°å€(<code class="highlighter-rouge">0x1314000</code>)ï¼Œè€Œæ˜¯åœ¨ç›¸å¯¹äºå †çš„èµ·å§‹åœ°å€åç§»äº†16ä¸ªå­—èŠ‚ã€‚å¦å¤–ï¼Œå½“æˆ‘ä»¬ç¬¬äºŒæ¬¡è°ƒç”¨<code class="highlighter-rouge">malloc(1024)</code>çš„æ—¶å€™ï¼ŒæŒ‰è¯´è¿”å›åœ°å€åº”è¯¥æ˜¯<code class="highlighter-rouge">1314410</code>(é¦–æ¬¡è°ƒç”¨mallocçš„è¿”å›åœ°å€<code class="highlighter-rouge">0x1314010</code> + <code class="highlighter-rouge">1024</code>å­—èŠ‚ã€‚è¯‘è€…æ³¨:ä½œè€…è¿™é‡Œå†™æˆäº†<code class="highlighter-rouge">0x1318010</code>, æœ‰ç¬”è¯¯)ï¼Œä½†å®é™…ä¸Šè¿”å›çš„æ˜¯<code class="highlighter-rouge">0x1318010</code>ï¼Œæˆ‘ä»¬åˆä¸¢å¤±äº†16å­—èŠ‚ï¼è€Œä¸”æ¥ä¸‹æ¥æ¯æ¬¡è°ƒç”¨<code class="highlighter-rouge">malloc</code>éƒ½ä¼šä¸¢å¤±16å­—èŠ‚ã€‚</p>

<p>æˆ‘ä»¬çœ‹çœ‹è¿™ä¸¢å¤±çš„16ä¸ªå­—èŠ‚é‡Œé¢æ˜¯ä»€ä¹ˆ(<code class="highlighter-rouge">5-main.c</code>) ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**                                                                                            
 * pmem - print mem                                                                            
 * @p: memory address to start printing from                                                   
 * @bytes: number of bytes to print                                                            
 *                                                                                             
 * Return: nothing                                                                             
 */
void pmem(void *p, unsigned int bytes)
{
    unsigned char *ptr;
    unsigned int i;

    ptr = (unsigned char *)p;
    for (i = 0; i &lt; bytes; i++)
    {
        if (i != 0)
        {
            printf(" ");
        }
        printf("%02x", *(ptr + i));
    }
    printf("\n");
}

/**
 * main - the 0x10 lost bytes
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;
    int i;

    for (i = 0; i &lt; 10; i++)
    {
        p = malloc(1024 * (i + 1));
        printf("%p\n", p);
        printf("bytes at %p:\n", (void *)((char *)p - 0x10));
        pmem((char *)p - 0x10, 0x10);
    }
    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 5-main.c -o 5
julien@holberton:~/holberton/w/hackthevm3$ ./5
0x1fa8010
bytes at 0x1fa8000:
00 00 00 00 00 00 00 00 11 04 00 00 00 00 00 00
0x1fa8420
bytes at 0x1fa8410:
00 00 00 00 00 00 00 00 11 08 00 00 00 00 00 00
0x1fa8c30
bytes at 0x1fa8c20:
00 00 00 00 00 00 00 00 11 0c 00 00 00 00 00 00
0x1fa9840
bytes at 0x1fa9830:
00 00 00 00 00 00 00 00 11 10 00 00 00 00 00 00
0x1faa850
bytes at 0x1faa840:
00 00 00 00 00 00 00 00 11 14 00 00 00 00 00 00
0x1fabc60
bytes at 0x1fabc50:
00 00 00 00 00 00 00 00 11 18 00 00 00 00 00 00
0x1fad470
bytes at 0x1fad460:
00 00 00 00 00 00 00 00 11 1c 00 00 00 00 00 00
0x1faf080
bytes at 0x1faf070:
00 00 00 00 00 00 00 00 11 20 00 00 00 00 00 00
0x1fb1090
bytes at 0x1fb1080:
00 00 00 00 00 00 00 00 11 24 00 00 00 00 00 00
0x1fb34a0
bytes at 0x1fb3490:
00 00 00 00 00 00 00 00 11 28 00 00 00 00 00 00
julien@holberton:~/holberton/w/hackthevm3$ 
</code></pre></div></div>
<p>ä»ä¸Šé¢çš„æ‰“å°å¯ä»¥çœ‹å‡ºä¸€ä¸ªè§„å¾‹ï¼šè¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°æ€»æ˜¯åœ¨å‰16ä¸ªå­—èŠ‚ä¸­å‡ºç°ã€‚æ¯”å¦‚ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚åˆ†é…<code class="highlighter-rouge">1024</code>(<code class="highlighter-rouge">0x400</code>)ä¸ªå­—èŠ‚ï¼Œå‰16ä¸ªå­—èŠ‚çš„å8ä¸ªå­—èŠ‚æ˜¯<code class="highlighter-rouge">11 04 00 00 00 00 00 00</code>ï¼Œ ä¹Ÿå°±æ˜¯æ•°å­—(å°ç«¯åº)<code class="highlighter-rouge">0x 00 00 00 00 00 00 04 11</code> = <code class="highlighter-rouge">0x400</code> (1024) + <code class="highlighter-rouge">0x10</code>(ä¸¢å¤±çš„16å­—èŠ‚) + <code class="highlighter-rouge">1</code>(åé¢æˆ‘ä»¬å†è®¨è®ºè¿™1ä¸ªå­—èŠ‚)ã€‚</p>

<p>å¯ä»¥çœ‹å‡ºï¼Œ<code class="highlighter-rouge">malloc</code>è¿”å›åœ°å€çš„å‰é¢<code class="highlighter-rouge">16</code>ä¸ªå­—èŠ‚ï¼Œéƒ½åŒ…å«è¢«åˆ†é…å†…å­˜å—çš„å¤§å°ï¼Œå³:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç”¨æˆ·è¯·æ±‚åˆ†é…å†…å­˜çš„å¤§å° + 0x10 + 1
</code></pre></div></div>

<p>è‡³æ­¤æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœæµ‹åˆ°è¿™16ä¸ªå­—èŠ‚ä¸­å­˜æ”¾çš„å¯èƒ½æ˜¯<code class="highlighter-rouge">malloc</code>å’Œ<code class="highlighter-rouge">free</code>ä¸ºäº†ç»´æŠ¤å †æ‰€ä½¿ç”¨çš„æ•°æ®ç»“æ„ã€‚å°½ç®¡ç›®å‰æˆ‘ä»¬è¿˜ä¸äº†è§£è¿™ä¸ªç»“æ„çš„ç»†èŠ‚ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“å †çš„èµ·å§‹åœ°å€ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªç»“æ„éå†<code class="highlighter-rouge">malloc</code>åˆ†é…çš„å†…å­˜å—ï¼ˆä¸è°ƒç”¨<code class="highlighter-rouge">free</code>çš„å‰æä¸‹ï¼‰ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼ˆ<code class="highlighter-rouge">6-main.c</code>ï¼‰ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**                                                                                            
 * pmem - print mem                                                                            
 * @p: memory address to start printing from                                                   
 * @bytes: number of bytes to print                                                            
 *                                                                                             
 * Return: nothing                                                                             
 */
void pmem(void *p, unsigned int bytes)
{
    unsigned char *ptr;
    unsigned int i;

    ptr = (unsigned char *)p;
    for (i = 0; i &lt; bytes; i++)
    {
        if (i != 0)
        {
            printf(" ");
        }
        printf("%02x", *(ptr + i));
    }
    printf("\n");
}

/**
 * main - using the 0x10 bytes to jump to next malloc'ed chunks
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;
    int i;
    void *heap_start;
    size_t size_of_the_block;

    heap_start = sbrk(0);
    write(1, "START\n", 6);
    for (i = 0; i &lt; 10; i++)
    {
        p = malloc(1024 * (i + 1)); 
        *((int *)p) = i;
        printf("%p: [%i]\n", p, i);
    }
    p = heap_start;
    for (i = 0; i &lt; 10; i++)
    {
        pmem(p, 0x10);
        size_of_the_block = *((size_t *)((char *)p + 8)) - 1;
        printf("%p: [%i] - size = %lu\n",
              (void *)((char *)p + 0x10),
              *((int *)((char *)p + 0x10)),
              size_of_the_block);
        p = (void *)((char *)p + size_of_the_block);
    }
    write(1, "END\n", 4);
    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 6-main.c -o 6
julien@holberton:~/holberton/w/hackthevm3$ ./6 
START
0x9e6010: [0]
0x9e6420: [1]
0x9e6c30: [2]
0x9e7840: [3]
0x9e8850: [4]
0x9e9c60: [5]
0x9eb470: [6]
0x9ed080: [7]
0x9ef090: [8]
0x9f14a0: [9]
00 00 00 00 00 00 00 00 11 04 00 00 00 00 00 00
0x9e6010: [0] - size = 1040
00 00 00 00 00 00 00 00 11 08 00 00 00 00 00 00
0x9e6420: [1] - size = 2064
00 00 00 00 00 00 00 00 11 0c 00 00 00 00 00 00
0x9e6c30: [2] - size = 3088
00 00 00 00 00 00 00 00 11 10 00 00 00 00 00 00
0x9e7840: [3] - size = 4112
00 00 00 00 00 00 00 00 11 14 00 00 00 00 00 00
0x9e8850: [4] - size = 5136
00 00 00 00 00 00 00 00 11 18 00 00 00 00 00 00
0x9e9c60: [5] - size = 6160
00 00 00 00 00 00 00 00 11 1c 00 00 00 00 00 00
0x9eb470: [6] - size = 7184
00 00 00 00 00 00 00 00 11 20 00 00 00 00 00 00
0x9ed080: [7] - size = 8208
00 00 00 00 00 00 00 00 11 24 00 00 00 00 00 00
0x9ef090: [8] - size = 9232
00 00 00 00 00 00 00 00 11 28 00 00 00 00 00 00
0x9f14a0: [9] - size = 10256
END
julien@holberton:~/holberton/w/hackthevm3$ 
</code></pre></div></div>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å›ç­”ä¸Šä¸€ç¯‡æ–‡ç« ä¸­çš„ä¸€ä¸ªé—®é¢˜ï¼š<code class="highlighter-rouge">malloc</code>æ¯åˆ†é…ä¸€å—å†…å­˜ï¼Œå°±åœ¨è¿™å—å†…å­˜å‰é¢çš„16å­—èŠ‚ä¸­å­˜æ”¾è¯¥å†…å­˜å—çš„å¤§å°ã€‚å†…å­˜è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œ<code class="highlighter-rouge">free</code>å‡½æ•°ä¼šä½¿ç”¨è¿™ä¸ªç»“æ„ï¼Œå¹¶å°†è¿™å—å†…å­˜æ”¾åœ¨ç©ºé—²åˆ—è¡¨ä¸­ï¼Œä»¥å¾…åç»­<code class="highlighter-rouge">malloc</code>çš„æ—¶å€™ä½¿ç”¨ã€‚</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/0x10-malloc.png" alt="" /></p>

<p>ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼šè¿™16ä¸ªå­—èŠ‚çš„å‰8ä¸ªå­—èŠ‚æ˜¯å¹²å˜›çš„å‘¢ï¼Ÿçœ‹èµ·æ¥å®ƒä»¬æ€»æ˜¯0ï¼Œéš¾é“æ˜¯å¡«å……å­—èŠ‚å—ï¼Ÿ</p>

<h3 id="ä»æºç æ‰¾ç­”æ¡ˆrtfsc">ä»æºç æ‰¾ç­”æ¡ˆï¼ˆRTFSCï¼‰###</h3>

<p>æˆ‘ä»¬çœ‹ä¸‹<code class="highlighter-rouge">malloc</code>çš„æºç ï¼ˆglibcä¸­çš„<code class="highlighter-rouge">malloc.c</code>)ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1055 /*
1056       malloc_chunk details:
1057    
1058        (The following includes lightly edited explanations by Colin Plumb.)
1059    
1060        Chunks of memory are maintained using a `boundary tag' method as
1061        described in e.g., Knuth or Standish.  (See the paper by Paul
1062        Wilson ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps for a
1063        survey of such techniques.)  Sizes of free chunks are stored both
1064        in the front of each chunk and at the end.  This makes
1065        consolidating fragmented chunks into bigger chunks very fast.  The
1066        size fields also hold bits representing whether chunks are free or
1067        in use.
1068    
1069        An allocated chunk looks like this:
1070    
1071    
1072        chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
1073                |             Size of previous chunk, if unallocated (P clear)  |
1074                +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
1075                |             Size of chunk, in bytes                     |A|M|P|
1076          mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
1077                |             User data starts here...                          .
1078                .                                                               .
1079                .             (malloc_usable_size() bytes)                      .
1080                .                                                               |
1081    nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
1082                |             (size of chunk, but used for application data)    |
1083                +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
1084                |             Size of next chunk, in bytes                |A|0|1|
1085                +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
1086    
1087        Where "chunk" is the front of the chunk for the purpose of most of
1088        the malloc code, but "mem" is the pointer that is returned to the
1089        user.  "Nextchunk" is the beginning of the next contiguous chunk.
</code></pre></div></div>
<p>æˆ‘ä»¬çŒœå¯¹äº†ã€‚åœ¨<code class="highlighter-rouge">malloc</code>è¿”å›ç»™ç”¨æˆ·åœ°å€çš„å‰é¢ï¼Œæœ‰ä¸¤ä¸ªå˜é‡ï¼š</p>

<ul>
  <li>å‰ä¸€ä¸ªå†…å­˜å—ï¼ˆå¦‚æœè¯¥å†…å†…å­˜å—å°šæœªè¢«åˆ†é…çš„è¯ï¼‰çš„å¤§å°ï¼›ä¾‹å­ä¸­æˆ‘ä»¬å¹¶æœª<code class="highlighter-rouge">free</code>å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°çš„è¿™ä¸€åŒºåŸŸæ€»æ˜¯0ã€‚</li>
  <li>å½“å‰å—çš„å¤§å°ã€‚</li>
</ul>

<p>æˆ‘ä»¬é‡Šæ”¾ä¸€äº›å†…å­˜æ¥çœ‹ä¸‹å‰8ä¸ªå­—èŠ‚çš„å˜åŒ–ï¼ˆ<code class="highlighter-rouge">7-main.c</code>ï¼‰ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**                                                                                            
 * pmem - print mem                                                                            
 * @p: memory address to start printing from                                                   
 * @bytes: number of bytes to print                                                            
 *                                                                                             
 * Return: nothing                                                                             
 */
void pmem(void *p, unsigned int bytes)
{
    unsigned char *ptr;
    unsigned int i;

    ptr = (unsigned char *)p;
    for (i = 0; i &lt; bytes; i++)
    {
        if (i != 0)
        {
            printf(" ");
        }
        printf("%02x", *(ptr + i));
    }
    printf("\n");
}

/**
 * main - confirm the source code
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;
    int i;
    size_t size_of_the_chunk;
    size_t size_of_the_previous_chunk;
    void *chunks[10];

    for (i = 0; i &lt; 10; i++)
    {
        p = malloc(1024 * (i + 1));
        chunks[i] = (void *)((char *)p - 0x10);
        printf("%p\n", p);
    }
    free((char *)(chunks[3]) + 0x10);
    free((char *)(chunks[7]) + 0x10);
    for (i = 0; i &lt; 10; i++)
    {
        p = chunks[i];
        printf("chunks[%d]: ", i);
        pmem(p, 0x10);
        size_of_the_chunk = *((size_t *)((char *)p + 8)) - 1;
        size_of_the_previous_chunk = *((size_t *)((char *)p));
        printf("chunks[%d]: %p, size = %li, prev = %li\n",
              i, p, size_of_the_chunk, size_of_the_previous_chunk);
    }
    return (EXIT_SUCCESS);
}
</code></pre></div></div>
<p>ç¼–è¯‘è¿è¡Œï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 7-main.c -o 7
julien@holberton:~/holberton/w/hackthevm3$ ./7
0x1536010
0x1536420
0x1536c30
0x1537840
0x1538850
0x1539c60
0x153b470
0x153d080
0x153f090
0x15414a0
chunks[0]: 00 00 00 00 00 00 00 00 11 04 00 00 00 00 00 00
chunks[0]: 0x1536000, size = 1040, prev = 0
chunks[1]: 00 00 00 00 00 00 00 00 11 08 00 00 00 00 00 00
chunks[1]: 0x1536410, size = 2064, prev = 0
chunks[2]: 00 00 00 00 00 00 00 00 11 0c 00 00 00 00 00 00
chunks[2]: 0x1536c20, size = 3088, prev = 0
chunks[3]: 00 00 00 00 00 00 00 00 11 10 00 00 00 00 00 00
chunks[3]: 0x1537830, size = 4112, prev = 0
chunks[4]: 10 10 00 00 00 00 00 00 10 14 00 00 00 00 00 00
chunks[4]: 0x1538840, size = 5135, prev = 4112
chunks[5]: 00 00 00 00 00 00 00 00 11 18 00 00 00 00 00 00
chunks[5]: 0x1539c50, size = 6160, prev = 0
chunks[6]: 00 00 00 00 00 00 00 00 11 1c 00 00 00 00 00 00
chunks[6]: 0x153b460, size = 7184, prev = 0
chunks[7]: 00 00 00 00 00 00 00 00 11 20 00 00 00 00 00 00
chunks[7]: 0x153d070, size = 8208, prev = 0
chunks[8]: 10 20 00 00 00 00 00 00 10 24 00 00 00 00 00 00
chunks[8]: 0x153f080, size = 9231, prev = 8208
chunks[9]: 00 00 00 00 00 00 00 00 11 28 00 00 00 00 00 00
chunks[9]: 0x1541490, size = 10256, prev = 0
julien@holberton:~/holberton/w/hackthevm3$ 
</code></pre></div></div>
<p>ä»ä¸Šé¢çš„æ‰“å°å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœå‰é¢çš„å†…å­˜å—è¢«é‡Šæ”¾äº†ï¼Œ<code class="highlighter-rouge">malloc</code>è¿”å›åœ°å€å‰é¢16ä¸ªå­—èŠ‚ä¸­çš„å‰8ä¸ªå­—èŠ‚ä»£è¡¨çš„å°±æ˜¯å‰ä¸€å†…å­˜å—çš„å¤§å°ã€‚æ‰€ä»¥ï¼Œ<code class="highlighter-rouge">malloc</code>åˆ†é…çš„å†…å­˜å—çš„å®Œæ•´ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/malloc-chunk.png" alt="" /></p>

<p>å¦å¤–ï¼Œ16ä¸ªå­—èŠ‚ä¸­å8å­—èŠ‚ï¼ˆä»£è¡¨æœ¬å†…å­˜å—å¤§å°çš„8ä¸ªå­—èŠ‚ï¼‰ä¸­çš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä½(æºç ä¸­çš„æ ‡è¯†ä½<code class="highlighter-rouge">P</code>)ä»£è¡¨ä¸Šä¸€ä¸ªå†…å­˜å—æ˜¯å¦è¢«å ç”¨ï¼ˆ<code class="highlighter-rouge">1</code>-è¢«å ç”¨ï¼Œ<code class="highlighter-rouge">0</code>-æœªå ç”¨ï¼‰ã€‚æ‰€ä»¥æ›´æ–°åçš„å®éªŒç¨‹åºå¦‚ä¸‹ (<code class="highlighter-rouge">8-main.c</code>)ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**                                                                                            
 * pmem - print mem                                                                            
 * @p: memory address to start printing from                                                   
 * @bytes: number of bytes to print                                                            
 *                                                                                             
 * Return: nothing                                                                             
 */
void pmem(void *p, unsigned int bytes)
{
    unsigned char *ptr;
    unsigned int i;

    ptr = (unsigned char *)p;
    for (i = 0; i &lt; bytes; i++)
    {
        if (i != 0)
        {
            printf(" ");
        }
        printf("%02x", *(ptr + i));
    }
    printf("\n");
}

/**
 * main - updating with correct checks
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;
    int i;
    size_t size_of_the_chunk;
    size_t size_of_the_previous_chunk;
    void *chunks[10];
    char prev_used;

    for (i = 0; i &lt; 10; i++)
    {
        p = malloc(1024 * (i + 1));
        chunks[i] = (void *)((char *)p - 0x10);
    }
    free((char *)(chunks[3]) + 0x10);
    free((char *)(chunks[7]) + 0x10);
    for (i = 0; i &lt; 10; i++)
    {
        p = chunks[i];
        printf("chunks[%d]: ", i);
        pmem(p, 0x10);
        size_of_the_chunk = *((size_t *)((char *)p + 8));
        prev_used = size_of_the_chunk &amp; 1;
        size_of_the_chunk -= prev_used;
        size_of_the_previous_chunk = *((size_t *)((char *)p));
        printf("chunks[%d]: %p, size = %li, prev (%s) = %li\n",
              i, p, size_of_the_chunk,
              (prev_used? "allocated": "unallocated"), size_of_the_previous_chunk);
    }
    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 8-main.c -o 8
julien@holberton:~/holberton/w/hackthevm3$ ./8 
chunks[0]: 00 00 00 00 00 00 00 00 11 04 00 00 00 00 00 00
chunks[0]: 0x1031000, size = 1040, prev (allocated) = 0
chunks[1]: 00 00 00 00 00 00 00 00 11 08 00 00 00 00 00 00
chunks[1]: 0x1031410, size = 2064, prev (allocated) = 0
chunks[2]: 00 00 00 00 00 00 00 00 11 0c 00 00 00 00 00 00
chunks[2]: 0x1031c20, size = 3088, prev (allocated) = 0
chunks[3]: 00 00 00 00 00 00 00 00 11 10 00 00 00 00 00 00
chunks[3]: 0x1032830, size = 4112, prev (allocated) = 0
chunks[4]: 10 10 00 00 00 00 00 00 10 14 00 00 00 00 00 00
chunks[4]: 0x1033840, size = 5136, prev (unallocated) = 4112
chunks[5]: 00 00 00 00 00 00 00 00 11 18 00 00 00 00 00 00
chunks[5]: 0x1034c50, size = 6160, prev (allocated) = 0
chunks[6]: 00 00 00 00 00 00 00 00 11 1c 00 00 00 00 00 00
chunks[6]: 0x1036460, size = 7184, prev (allocated) = 0
chunks[7]: 00 00 00 00 00 00 00 00 11 20 00 00 00 00 00 00
chunks[7]: 0x1038070, size = 8208, prev (allocated) = 0
chunks[8]: 10 20 00 00 00 00 00 00 10 24 00 00 00 00 00 00
chunks[8]: 0x103a080, size = 9232, prev (unallocated) = 8208
chunks[9]: 00 00 00 00 00 00 00 00 11 28 00 00 00 00 00 00
chunks[9]: 0x103c490, size = 10256, prev (allocated) = 0
julien@holberton:~/holberton/w/hackthevm3$ 
</code></pre></div></div>
<p>ç»“åˆä¸Šé¢çš„è¾“å‡ºï¼Œæ³¨æ„ä¸‹é¢è®¡ç®—æœ¬å†…å­˜å—å¤§å°çš„ä»£ç ï¼Œä½ æ˜¯å¦å·²ç»æ˜ç™½å¤šå‡ºæ¥çš„<code class="highlighter-rouge">1</code>ä¸ªå­—èŠ‚äº†æ˜¯æ€ä¹ˆå›äº‹äº†ï¼Ÿ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	size_of_the_chunk = *((size_t *)((char *)p + 8));
	prev_used = size_of_the_chunk &amp; 1;
	size_of_the_chunk -= prev_used;
</code></pre></div></div>

<h2 id="å…­å †çœŸçš„æ˜¯å‘ä¸Šç”Ÿé•¿å—">å…­ã€å †çœŸçš„æ˜¯å‘ä¸Šç”Ÿé•¿å—</h2>
<p>è¿™æ˜¯æœ€åä¸€ä¸ªæœªè§£å†³çš„é—®é¢˜ã€‚ä»<code class="highlighter-rouge">man brk</code>çœ‹ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DESCRIPTION
       brk() and sbrk() change the location of the program break, which defines the end  of  the
       process's  data  segment  (i.e., the program break is the first location after the end of
       the uninitialized data segment).  Increasing the program break has the effect of allocatâ€
       ing memory to the process; decreasing the break deallocates memory.
</code></pre></div></div>

<p>æˆ‘ä»¬é€šè¿‡ç¨‹åºéªŒè¯ä¸‹ï¼ˆ<code class="highlighter-rouge">9-main.c</code>ï¼‰ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**
 * main - moving the program break
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    int i;

    write(1, "START\n", 6);
    malloc(1);
    getchar();
    write(1, "LOOP\n", 5);
    for (i = 0; i &lt; 0x25000 / 1024; i++)
    {
        malloc(1024);
    }
    write(1, "END\n", 4);
    getchar();
    return (EXIT_SUCCESS);
}
</code></pre></div></div>
<p>è¿è¡Œè¿‡ç¨‹ä¸­æˆ‘ä»¬ä½¿ç”¨<code class="highlighter-rouge">strace</code>è·Ÿè¸ªï¼Œçœ‹ä¸‹ç³»ç»Ÿè°ƒç”¨<code class="highlighter-rouge">brk</code>ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ strace ./9 
execve("./9", ["./9"], [/* 61 vars */]) = 0
...
write(1, "START\n", 6START
)                  = 6
brk(0)                                  = 0x1fd8000
brk(0x1ff9000)                          = 0x1ff9000
...
write(1, "LOOP\n", 5LOOP
)                   = 5
brk(0x201a000)                          = 0x201a000
write(1, "END\n", 4END
)                    = 4
...
julien@holberton:~/holberton/w/hackthevm3$ 
</code></pre></div></div>

<p>å¯ä»¥çœ‹å‡ºï¼Œ<code class="highlighter-rouge">malloc</code>å…±è°ƒç”¨äº†ä¸¤æ¬¡<code class="highlighter-rouge">brk</code>æ¥å¢åŠ å †å¤§å°ï¼Œå¹¶ä¸”ç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ä¼ ç»™<code class="highlighter-rouge">brk</code>çš„å‚æ•°ï¼ˆ<code class="highlighter-rouge">0x201a000</code>ï¼‰æ¯”ç¬¬ä¸€æ¬¡å¤§ï¼ˆ<code class="highlighter-rouge">0x1ff9000</code>ï¼‰ã€‚ç¬¬äºŒæ¬¡è°ƒç”¨<code class="highlighter-rouge">brk</code>æ˜¯å› ä¸ºç¬¬ä¸€æ¬¡åˆ†é…çš„å †ä¸å¤Ÿ<code class="highlighter-rouge">malloc</code>ä½¿ç”¨äº†ã€‚</p>

<p>æˆ‘ä»¬é€šè¿‡<code class="highlighter-rouge">/proc</code>æ–‡ä»¶å†æ¬¡ç¡®è®¤ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 9-main.c -o 9
julien@holberton:~/holberton/w/hackthevm3$ ./9
START
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/7855$ ps aux | grep \ \./9$
julien     7972  0.0  0.0   4332   684 pts/9    S+   19:08   0:00 ./9
julien@holberton:/proc/7855$ cd /proc/7972
julien@holberton:/proc/7972$ cat maps
...
00901000-00922000 rw-p 00000000 00:00 0                                  [heap]
...
julien@holberton:/proc/7972$ 
</code></pre></div></div>

<p>æ­¤æ—¶çš„å †åŒºæ®µæ˜¯ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00901000-00922000 rw-p 00000000 00:00 0 [heap]
</code></pre></div></div>

<p>æˆ‘ä»¬æŒ‰ä¸‹å›è½¦é”®è®©ç¨‹åºç»§ç»­è¿è¡Œï¼Œå¹¶æŸ¥çœ‹å †åŒºæ®µï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOOP
END
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:/proc/7972$ cat maps
...
00901000-00943000 rw-p 00000000 00:00 0                                  [heap]
...
julien@holberton:/proc/7972$ 
</code></pre></div></div>

<p>æ­¤æ—¶çš„å †åŒºæ®µæ˜¯ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00901000-00943000 rw-p 00000000 00:00 0 [heap]
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå †çš„èµ·å§‹åœ°å€æ²¡å˜ï¼Œä½†æ˜¯ç»“æŸåœ°å€å·²ç»ä»<code class="highlighter-rouge">00922000</code>å˜ä¸º <code class="highlighter-rouge">00943000</code>ã€‚ç”±æ­¤å¯è§ï¼Œ<strong>å †ç¡®å®æ˜¯å‘ä¸Šç”Ÿé•¿çš„ã€‚</strong></p>

<h2 id="ä¸ƒåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–aslr">ä¸ƒã€åœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–(ASLR)</h2>

<p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°<code class="highlighter-rouge">/proc/pid/maps</code>ä¸­çš„å¥‡æ€ªäº‹æƒ…ï¼š</p>

<p><code class="highlighter-rouge">program break</code>æ˜¯æ•°æ®æ®µçš„å½“å‰ç»“æŸä½ç½®ï¼Œå› æ­¤åº”è¯¥ï¼ˆåœ¨è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼‰ç´§æŒ¨ç€å¯æ‰§è¡Œæ–‡ä»¶ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œå †ä¹Ÿåº”è¯¥ä»å¯æ‰§è¡Œæ–‡ä»¶ç»“æŸçš„åœ°å€å¼€å§‹ã€‚ä½†æ˜¯ä»ä¹‹å‰çš„æ‰“å°å¯ä»¥çœ‹åˆ°ï¼Œäº‹å®å¹¶ä¸æ˜¯è¿™æ ·çš„ã€‚å”¯ä¸€æ­£ç¡®çš„æ˜¯åœ¨å†…å­˜è™šæ‹Ÿç©ºé—´ä¸­ï¼Œå †æ€»æ˜¯å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸‹ä¸€ä¸ªåŒºæ®µï¼Œè¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºå †æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æ•°æ®æ®µçš„ä¸€éƒ¨åˆ†ã€‚å¦å¤–ï¼Œä»”ç»†è§‚å¯Ÿå‘ç°ï¼Œå¯æ‰§è¡ŒåŒºæ®µå’Œå †ä¹‹é—´çš„é—´éš”æ€»æ˜¯ä¸åŒçš„:</p>

<p><em>ä¸‹é¢åˆ—ä¸¾äº†å‡ ä¸ªä¾‹å­ï¼Œè¯´æ˜å¯æ‰§è¡ŒåŒºå’Œå †ä¹‹é—´çš„é—´éš”ã€‚æ¯ä¸€è¡Œçš„æ ¼å¼æ˜¯ï¼š<br />
  <code class="highlighter-rouge">[è¿›ç¨‹å·] å †èµ·å§‹åœ°å€ - å¯æ‰§è¡ŒåŒºç»“æŸåœ°å€ = é—´éš”</code></em></p>

<ul>
  <li><code class="highlighter-rouge">[3718]:01195000 â€“ 00602000 = b93000</code></li>
  <li><code class="highlighter-rouge">[3834]:024d6000 â€“ 00602000 = 1ed4000</code></li>
  <li><code class="highlighter-rouge">[4014]:00e70000 â€“ 00602000 = 86e000</code></li>
  <li><code class="highlighter-rouge">[4172]:01314000 â€“ 00602000 = d12000</code></li>
  <li><code class="highlighter-rouge">[7972]:00901000 â€“ 00602000 = 2ff000</code></li>
</ul>

<p>çœ‹èµ·æ¥äºŒè€…ä¹‹é—´çš„é—´éš”æ˜¯éšæœºçš„ï¼Œäº‹å®ä¸Šï¼Œç¡®å®æ˜¯éšæœºçš„ã€‚é€šè¿‡æŸ¥çœ‹ELFäºŒè¿›åˆ¶åŠ è½½ç›¸å…³çš„æºç ï¼ˆ<code class="highlighter-rouge">fs/binfmt_elf.c</code>ï¼‰å¯ä»¥å‘ç°ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        if ((current-&gt;flags &amp; PF_RANDOMIZE) &amp;&amp; (randomize_va_space &gt; 1)) {
                current-&gt;mm-&gt;brk = current-&gt;mm-&gt;start_brk =
                        arch_randomize_brk(current-&gt;mm);
#ifdef compat_brk_randomized
                current-&gt;brk_randomized = 1;
#endif
        }
</code></pre></div></div>
<p>å…¶ä¸­çš„<code class="highlighter-rouge">current-&gt;mm-&gt;brk</code>å°±æ˜¯<code class="highlighter-rouge">program break</code>çš„åœ°å€ã€‚å‡½æ•°<code class="highlighter-rouge">arch_randomize_brk</code>å¯ä»¥åœ¨æ–‡ä»¶<code class="highlighter-rouge">arch/x86/kernel/process.c</code>ä¸­æ‰¾åˆ°ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsigned long arch_randomize_brk(struct mm_struct *mm)
{
        unsigned long range_end = mm-&gt;brk + 0x02000000;
        return randomize_range(mm-&gt;brk, range_end, 0) ? : mm-&gt;brk;
}
</code></pre></div></div>

<p>å…¶ä¸­<code class="highlighter-rouge">randomize_range</code>è¿”å›ä¸€ä¸ªèµ·å§‹åœ°å€ï¼Œ<code class="highlighter-rouge">randomize_range</code>æºç å¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * randomize_range() returns a start address such that
 *
 *    [...... &lt;range&gt; .....]
 *  start                  end
 *
 * a &lt;range&gt; with size "len" starting at the return value is inside in the
 * area defined by [start, end], but is otherwise randomized.
 */
unsigned long
randomize_range(unsigned long start, unsigned long end, unsigned long len)
{
        unsigned long range = end - len - start;

        if (end &lt;= start + len)
                return 0;
        return PAGE_ALIGN(get_random_int() % range + start);
}
</code></pre></div></div>
<p>è¿™æ ·å°±å¯¼è‡´ï¼Œå¯æ‰§è¡Œæ–‡ä»¶æ•°æ®æ®µå’Œ<code class="highlighter-rouge">program break</code>åˆå§‹ä½ç½®ä¹‹é—´å°±å­˜åœ¨ä¸€ä¸ªéšæœºé—´éš”ï¼Œé—´éš”å¤§å°å¯èƒ½æ˜¯<code class="highlighter-rouge">0</code>åˆ°<code class="highlighter-rouge">0x02000000</code>ä¹‹é—´çš„ä»»ä¸€æ•°å€¼ã€‚è¿™ä¸€éšæœºå€¼è¢«ç§°ä¸ºåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–(ASLR)ã€‚ASLRæ˜¯ä¸€é¡¹è®¡ç®—æœºå®‰å…¨æŠ€æœ¯ï¼Œç”¨æ¥é˜²æ­¢å†…å­˜æ”»å‡»ã€‚ä¾‹å¦‚ï¼Œä¸ºäº†é˜²æ­¢é»‘å®¢è·³è½¬åˆ°å†…å­˜ä¸­çš„ç‰¹å®šå‡½æ•°ï¼ŒASLRå°†è¿›ç¨‹çš„å †ã€æ ˆç­‰å…³é”®æ•°æ®åŒºåŸŸåœ¨å†…å­˜åœ°å€ç©ºé—´ä¸­çš„ä½ç½®éšæœºåŒ–ã€‚</p>

<h2 id="å…«è¿›ç¨‹åœ°å€ç©ºé—´ç¤ºæ„å›¾">å…«ã€è¿›ç¨‹åœ°å€ç©ºé—´ç¤ºæ„å›¾</h2>

<p>ç»“åˆå‰é¢æˆ‘ä»¬å­¦åˆ°çš„çŸ¥è¯†ï¼Œå¯ä»¥ç”»å‡ºæ–°çš„è¿›ç¨‹åœ°å€ç©ºé—´å›¾ï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/virtual_memory_diagram_v2.png" alt="" /></p>

<h2 id="ä¹malloc0">ä¹ã€malloc(0)</h2>

<p>ä½ æœ‰æ²¡æœ‰æƒ³è¿‡<code class="highlighter-rouge">malloc</code> <code class="highlighter-rouge">0</code>å­—èŠ‚å†…å­˜ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼ˆ<code class="highlighter-rouge">10-main.c</code>ï¼‰ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;

/**                                                                                            
 * pmem - print mem                                                                            
 * @p: memory address to start printing from                                                   
 * @bytes: number of bytes to print                                                            
 *                                                                                             
 * Return: nothing                                                                             
 */
void pmem(void *p, unsigned int bytes)
{
    unsigned char *ptr;
    unsigned int i;

    ptr = (unsigned char *)p;
    for (i = 0; i &lt; bytes; i++)
    {
        if (i != 0)
        {
            printf(" ");
        }
        printf("%02x", *(ptr + i));
    }
    printf("\n");
}

/**
 * main - moving the program break
 *
 * Return: EXIT_FAILURE if something failed. Otherwise EXIT_SUCCESS
 */
int main(void)
{
    void *p;
    size_t size_of_the_chunk;
    char prev_used;

    p = malloc(0);
    printf("%p\n", p);
    pmem((char *)p - 0x10, 0x10);
    size_of_the_chunk = *((size_t *)((char *)p - 8));
    prev_used = size_of_the_chunk &amp; 1;
    size_of_the_chunk -= prev_used;
    printf("chunk size = %li bytes\n", size_of_the_chunk);
    return (EXIT_SUCCESS);
}
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>julien@holberton:~/holberton/w/hackthevm3$ gcc -Wall -Wextra -pedantic -Werror 10-main.c -o 10
julien@holberton:~/holberton/w/hackthevm3$ ./10
0xd08010
00 00 00 00 00 00 00 00 21 00 00 00 00 00 00 00
chunk size = 32 bytes
julien@holberton:~/holberton/w/hackthevm3$ 
</code></pre></div></div>
<p>å¯ä»¥çœ‹å‡ºï¼Œ<code class="highlighter-rouge">malloc(0)</code>å®é™…ä¸Šå ç”¨äº†32ä¸ªå­—èŠ‚ï¼ˆåŒ…å«<code class="highlighter-rouge">malloc</code>è¿”å›åœ°å€å‰çš„16ä¸ªå­—èŠ‚ï¼‰ã€‚ä¸è¿‡ï¼Œè¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰å¹³å°ä¸Šéƒ½å¦‚æ­¤ã€‚ä»<code class="highlighter-rouge">man malloc</code>å¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NULL may also be returned by a successful call to malloc() with a size of zero
</code></pre></div></div>

<h2 id="åç»“å°¾">åã€ç»“å°¾</h2>
<p>æœ¬æ–‡æˆ‘ä»¬å­¦æ ¡äº†æœ‰å…³<code class="highlighter-rouge">malloc</code>å’Œå †çš„è®¸å¤šçŸ¥è¯†ã€‚ä½†å®é™…ä¸Šè¿œä¸æ­¢<code class="highlighter-rouge">brk</code>å’Œ<code class="highlighter-rouge">sbrk</code>ï¼Œä½ å¯ä»¥è¯•ç€åˆ†é…ä¸€å¤§å—å†…å­˜ï¼Œå¹¶ç”¨<code class="highlighter-rouge">strace</code>è·Ÿè¸ªä¸‹ï¼Œç„¶åæŸ¥çœ‹<code class="highlighter-rouge">/proc</code>ç³»åˆ—æ–‡ä»¶ï¼Œè¿™éƒ½æ˜¯æœ‰å¾…è¿›ä¸€æ­¥æ¢ç©¶çš„ã€‚</p>

<p>å¦å¤–ï¼Œ<code class="highlighter-rouge">free</code>å‡½æ•°æ˜¯æ€ä¹ˆå’Œ<code class="highlighter-rouge">malloc</code>å‡½æ•°åä½œçš„ï¼Œè¿™ä¹Ÿæ˜¯æœ‰å¾…è¿›ä¸€æ­¥æ¢ç©¶çš„ã€‚ è¿™ä¼šè®©ä½ æ˜ç™½ä¸ºä»€ä¹ˆæœ€å°çš„å†…å­˜å—æ˜¯<code class="highlighter-rouge">32</code>å­—èŠ‚è€Œä¸æ˜¯<code class="highlighter-rouge">16</code>å­—èŠ‚ï¼Œæˆ–è€…<code class="highlighter-rouge">0</code>å­—èŠ‚ã€‚</p>

<h2 id="åä¸€ç»§ç»­é˜…è¯»">åä¸€ã€ç»§ç»­é˜…è¯»</h2>

<ul>
  <li>ç¬¬ä¸€ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/12/Virtual_Memory_C_strings_proc/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸€ç¯‡:C strings &amp; /proc</a></li>
  <li>ç¬¬äºŒç¯‡:<a href="http://blog.coderhuo.tech/2017/10/15/Virtual_Memory_python_bytes/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬äºŒç¯‡:Python å­—èŠ‚</a></li>
  <li>ç¬¬ä¸‰ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/16/Virtual_Memory_drawing_VM_diagram/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸‰ç¯‡:ä¸€æ­¥ä¸€æ­¥ç”»è™šæ‹Ÿå†…å­˜å›¾</a></li>
  <li>ç¬¬å››ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/18/Virtual_Memory_malloc_and_heap/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬å››ç¯‡:malloc, heap &amp; the program break</a></li>
  <li>ç¬¬äº”ç¯‡:<a href="http://blog.coderhuo.tech/2019/08/31/Virtual_Memory_malloc_and_heap_stack_and_register/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬äº”ç¯‡:The Stack, registers and assembly code</a></li>
</ul>

<h2 id="åäºŒåŸæ–‡é“¾æ¥">åäºŒã€åŸæ–‡é“¾æ¥</h2>
<p><a href="https://blog.holbertonschool.com/hack-the-virtual-memory-malloc-the-heap-the-program-break/">Hack the Virtual Memory: malloc, the heap &amp; the program break</a></p>
:ET