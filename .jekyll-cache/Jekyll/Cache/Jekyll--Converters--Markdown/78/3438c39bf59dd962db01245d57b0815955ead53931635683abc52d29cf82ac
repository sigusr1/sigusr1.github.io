I"÷.<ul id="markdown-toc">
  <li><a href="#ä¸€é¦–å…ˆç¡®è®¤æ˜¯å¦æ”¯æŒç¡¬ä»¶watchpoint" id="markdown-toc-ä¸€é¦–å…ˆç¡®è®¤æ˜¯å¦æ”¯æŒç¡¬ä»¶watchpoint">ä¸€ã€é¦–å…ˆç¡®è®¤æ˜¯å¦æ”¯æŒç¡¬ä»¶watchpoint</a></li>
  <li><a href="#äºŒæ‰“å¼€ç›‘æ§æ¨¡å¼" id="markdown-toc-äºŒæ‰“å¼€ç›‘æ§æ¨¡å¼">äºŒã€æ‰“å¼€ç›‘æ§æ¨¡å¼</a></li>
  <li><a href="#ä¸‰è®¾ç½®watchpoint" id="markdown-toc-ä¸‰è®¾ç½®watchpoint">ä¸‰ã€è®¾ç½®watchpoint</a></li>
  <li><a href="#å››å‚è€ƒèµ„æ–™" id="markdown-toc-å››å‚è€ƒèµ„æ–™">å››ã€å‚è€ƒèµ„æ–™</a></li>
</ul>
<p>æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ARMå¹³å°çš„ç¡¬ä»¶watchpointå®šä½è¸©å†…å­˜é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•åœ¨è¿è¡Œè¿‡ç¨‹ä¸­è‡ªåŠ¨å¯¹ç‰¹å®šå†…å­˜åŒºåŸŸæ·»åŠ watchpointã€‚</p>

<p>åœ¨è¸©å†…å­˜é—®é¢˜ä¸­ï¼Œæœ€å›°éš¾çš„å°±æ˜¯æ‰¾å‡ºå…ƒå‡¶ã€‚å¸¸è§çš„ä½œæ³•å¦‚ä¸‹ï¼š</p>
<ol>
  <li>é€šè¿‡gdbæ‰“å†…å­˜æ–­ç‚¹ï¼ˆæ·»åŠ watchpoint), çœ‹çœ‹è°éæ³•è®¿é—®äº†è¯¥å†…å­˜åŒºåŸŸã€‚æœ¬æ–¹æ³•çš„å±€é™æ€§åœ¨äºï¼šæœ‰äº›ç³»ç»Ÿä¸æ”¯æŒgdbï¼Œæˆ–è€…è¢«è¸©å†…å­˜åœ°å€ä¸å›ºå®šï¼Œæˆ–è€…é—®é¢˜å‡ºç°åœ¨å¯åŠ¨é˜¶æ®µï¼Œæ¥ä¸åŠè®¾ç½®æ–­ç‚¹ã€‚</li>
  <li>é€šè¿‡MMUï¼ˆLinuxä¸‹å¯ä»¥ä½¿ç”¨mrotectï¼‰å¯¹ç‰¹å®šå†…å­˜åŒºåŸŸè¿›è¡Œä¿æŠ¤ã€‚æœ¬æ–¹æ³•çš„å±€é™æ€§åœ¨äºï¼šMMUä¿æŠ¤çš„æœ€å°å•ä½æ˜¯ä¸€ä¸ªå†…å­˜é¡µï¼ˆä¸€èˆ¬ä¸º4KBï¼‰ï¼Œæœ‰å¯èƒ½å—å®³å†…å­˜åŒºåŸŸè¾ƒå°ï¼Œæ— æ³•ç”¨MMUè¿›è¡Œä¿æŠ¤ã€‚</li>
  <li>dumpäº‹å‘ç°åœºå‘¨è¾¹çš„å†…å­˜ï¼Œé€šè¿‡å…³é”®å­—è¯†åˆ«è°å¯¹è¿™å—å†…å­˜è¿›è¡Œäº†éæ³•å†™å…¥ã€‚æ¯”å¦‚å—å®³å†…å­˜åŒºåŸŸä¸­æœ‰0xAABBå­—æ ·ï¼Œè€Œåªæœ‰æŸä¸ªæ¨¡å—ä¼šäº§ç”Ÿ0xAABBçš„æ•°æ®ï¼ŒåŸºäºæ­¤å°±å¯ä»¥é”å®šå‡¶æ‰‹ã€‚ä½†æ˜¯å¹¶éæ¯ä¸ªæ¨¡å—çš„æ•°æ®éƒ½æ˜¯æœ‰ç‰¹å¾çš„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ— æ³•é€šè¿‡è¯¥æ–¹æ³•æ‰¾åˆ°å‡¶æ‰‹ã€‚</li>
</ol>

<p>è¿™æ—¶å¯ä»¥å°è¯•èŠ¯ç‰‡è‡ªå¸¦çš„<strong>ç¡¬ä»¶watchpointåŠŸèƒ½</strong>ï¼Œ ARMå¹³å°å’Œx86/64ä¸€èˆ¬å‡æ”¯æŒã€‚å…¶å®gdbçš„watchpointå¤§å¤šæ•°æƒ…å†µä¸‹å°±æ˜¯åŸºäºç¡¬ä»¶ä¸­æ–­å®ç°çš„ï¼ˆ<a href="https://sourceware.org/gdb/wiki/Internals%20Watchpoints">https://sourceware.org/gdb/wiki/Internals%20Watchpoints</a>)ã€‚</p>

<p>ä¸‹é¢åŸºäºARM Cortex-A9ä»‹ç»å¦‚ä½•ä½¿ç”¨è¯¥åŠŸèƒ½ï¼Œæœ¬æ–‡å¤§é‡å¼•ç”¨<a href="http://infocenter.arm.com/help/topic/com.arm.doc.100511_0401_10_en/arm_cortexa9_trm_100511_0401_10_en.pdf">ã€ŠARMÂ® CortexÂ®-A9 Technical Reference Manualã€‹</a> ã€<a href="https://static.docs.arm.com/ddi0406/c/DDI0406C_C_arm_architecture_reference_manual.pdf">ã€ŠARMÂ® Architecture Reference Manual
ARMv7-A and ARMv7-R editionã€‹</a>å’Œ<a href="https://github.com/torvalds/linux/blob/9331b6740f86163908de69f4008e434fe0c27691/arch/arm/kernel/hw_breakpoint.c">hw_breakpoint.c</a>ä¸­çš„å†…å®¹ã€‚</p>

<h2 id="ä¸€é¦–å…ˆç¡®è®¤æ˜¯å¦æ”¯æŒç¡¬ä»¶watchpoint">ä¸€ã€é¦–å…ˆç¡®è®¤æ˜¯å¦æ”¯æŒç¡¬ä»¶watchpoint</h2>

<p>è¿™ä¸ªå¿…é¡»æŸ¥å¯¹åº”èŠ¯ç‰‡çš„æŠ€æœ¯æ‰‹å†Œã€‚ä»<a href="http://infocenter.arm.com/help/topic/com.arm.doc.100511_0401_10_en/arm_cortexa9_trm_100511_0401_10_en.pdf">ã€ŠARMÂ® CortexÂ®-A9 Technical Reference Manualã€‹</a>10.3.2èŠ‚ï¼ˆBreakpoints and watchpointsï¼‰å¯ä»¥çœ‹åˆ°ï¼Œæœ¬å¤„ç†å™¨æ”¯æŒ6ä¸ªbreakpointsã€4ä¸ªwatchpointsã€‚</p>

<h2 id="äºŒæ‰“å¼€ç›‘æ§æ¨¡å¼">äºŒã€æ‰“å¼€ç›‘æ§æ¨¡å¼</h2>

<p><em>æœ¬èŠ‚çš„åŸç†å¯ä»¥å‚è€ƒ<a href="https://static.docs.arm.com/ddi0406/c/DDI0406C_C_arm_architecture_reference_manual.pdf">ã€ŠARMÂ® Architecture Reference Manual
ARMv7-A and ARMv7-R editionã€‹</a> C11.11.20 DBGDSCR, Debug Status and Control Register è¿™ä¸€èŠ‚ã€‚</em></p>

<p><em>æœ¬èŠ‚æ‰€å±•ç¤ºä»£ç å‡æ‘˜è‡ªæˆ–åŸºäº<a href="https://github.com/torvalds/linux/blob/9331b6740f86163908de69f4008e434fe0c27691/arch/arm/kernel/hw_breakpoint.c">hw_breakpoint.c</a>ä¸­ç›¸å…³ä»£ç æ”¹å†™ã€‚</em></p>

<p>è¦æƒ³ä½¿ç”¨ç¡¬ä»¶watchpointï¼Œå¿…é¡»å…ˆæ‰“å¼€ç›‘æ§æ¨¡å¼ã€‚ä¸‹é¢çš„ä»£ç å¯ä»¥åˆ¤æ–­å½“å‰æ˜¯å¦å·²ç»æ‰“å¼€ç›‘æ§æ¨¡å¼ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * In order to access the breakpoint/watchpoint control registers,
 * we must be running in debug monitor mode.
 */
static int monitor_mode_enabled(void)
{
	u32 dscr;
	ARM_DBG_READ(c0, c1, 0, dscr);
	return !!(dscr &amp; ARM_DSCR_MDBGEN);
}
</code></pre></div></div>

<p>å…¶ä¸­å¯„å­˜å™¨è¯»å†™æ“ä½œçš„å®å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define ARM_DSCR_HDBGEN		(1 &lt;&lt; 14) /* DSCR halting bits. */
#define ARM_DSCR_MDBGEN		(1 &lt;&lt; 15) /* DSCR monitor bits. */

/* Accessor macros for the debug registers. */
#define ARM_DBG_READ(N, M, OP2, VAL) do {\
	asm volatile("mrc p14, 0, %0, " #N "," #M ", " #OP2 : "=r" (VAL));\
} while (0)

#define ARM_DBG_WRITE(N, M, OP2, VAL) do {\
	asm volatile("mcr p14, 0, %0, " #N "," #M ", " #OP2 : : "r" (VAL));\
} while (0)
</code></pre></div></div>

<p>ä¸‹é¢çš„ä»£ç å¯ä»¥æ‰“å¼€ç›‘æ§æ¨¡å¼ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static int enable_monitor_mode(void)
{
	u32 dscr;
	ARM_DBG_READ(c0, c1, 0, dscr);

	/* If monitor mode is already enabled, just return. */
	if (dscr &amp; ARM_DSCR_MDBGEN)
		goto out;

	/* Write to the corresponding DSCR. */
	/* æ ¹æ®ä¸åŒçš„å¹³å°ï¼Œè°ƒç”¨ä¸åŒçš„ä»£ç æ‰“å¼€ç›‘æ§æ¨¡å¼ */
	switch (get_debug_arch()) {
	case ARM_DEBUG_ARCH_V6:
	case ARM_DEBUG_ARCH_V6_1:
		ARM_DBG_WRITE(c0, c1, 0, (dscr | ARM_DSCR_MDBGEN));
		break;
	case ARM_DEBUG_ARCH_V7_ECP14:
	case ARM_DEBUG_ARCH_V7_1:
	case ARM_DEBUG_ARCH_V8:
		ARM_DBG_WRITE(c0, c2, 2, (dscr | ARM_DSCR_MDBGEN));
		isb();
		break;
	default:
		return -ENODEV;
	}

	/* Check that the write made it through. */
	/* æ£€æŸ¥æ˜¯å¦å·²ç»æ‰“å¼€ç›‘æ§æ¨¡å¼ */
	ARM_DBG_READ(c0, c1, 0, dscr);
	if (!(dscr &amp; ARM_DSCR_MDBGEN)) {
		pr_warn_once("Failed to enable monitor mode on CPU %d.\n",
				smp_processor_id());
		return -EPERM;
	}

out:
	return 0;
}
</code></pre></div></div>

<h2 id="ä¸‰è®¾ç½®watchpoint">ä¸‰ã€è®¾ç½®watchpoint</h2>

<p><em>æœ¬èŠ‚çš„åŸç†å¯ä»¥å‚è€ƒ<a href="http://infocenter.arm.com/help/topic/com.arm.doc.100511_0401_10_en/arm_cortexa9_trm_100511_0401_10_en.pdf">ã€ŠARMÂ® CortexÂ®-A9 Technical Reference Manualã€‹</a> 10.5.3 (Watchpoint Value Registers)å’Œ 10.5.4(Watchpoint Control Registers) è¿™ä¸¤èŠ‚ã€‚</em></p>

<p><em>æœ¬èŠ‚æ‰€å±•ç¤ºä»£ç å‡æ‘˜è‡ªæˆ–åŸºäº<a href="https://github.com/torvalds/linux/blob/9331b6740f86163908de69f4008e434fe0c27691/arch/arm/kernel/hw_breakpoint.c">hw_breakpoint.c</a>ä¸­ç›¸å…³ä»£ç æ”¹å†™ã€‚</em></p>

<p>ç¡¬ä»¶watchpointåŠŸèƒ½ï¼Œæ˜¯ç”±Watchpoint Value Registerï¼ˆWVRï¼‰å’ŒWatchpoint Control Register(WCR)ä¸¤ä¸ªå¯„å­˜å™¨é…å¯¹å®ç°çš„ï¼Œå‰è€…è®¾ç½®è¢«ç›‘æ§åœ°å€ï¼ˆè™šæ‹Ÿå†…å­˜åœ°å€ï¼Œè€Œä¸æ˜¯ç‰©ç†å†…å­˜åœ°å€ï¼Œè¿™çœå»äº†è½¬æ¢ç¯èŠ‚ï¼Œæå¤§çš„æ–¹ä¾¿äº†è°ƒè¯•ï¼‰ï¼Œåè€…è¿›è¡Œæ§åˆ¶ã€‚</p>

<p>ä¸‹é¢çš„ä»£ç å¯ä»¥ç”¨æ¥è®¾ç½®Watchpointï¼Œå®ƒçš„ä½œç”¨æ˜¯ï¼šå¦‚æœæœ‰äººåœ¨ç”¨æˆ·æ€å¾€addrå¼€å§‹çš„å‰ä¸¤ä¸ªå­—èŠ‚å†™å…¥å†…å®¹ï¼Œå°±ä¼šäº§ç”Ÿå¼‚å¸¸ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * i: watchpointå¯„å­˜å™¨åºå·ï¼Œå¯¹äºARM-A9, å¯ç”¨å¯„å­˜å™¨ä¸ºc0~c3, i å–å€¼èŒƒå›´ä¸º0~3
 * addr: å¿…é¡»æ˜¯è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œä¸”å¿…é¡»æ˜¯å­—å¯¹é½çš„ï¼ˆ32ä½ç³»ç»Ÿä¸º4å­—èŠ‚å¯¹é½ï¼‰
 * we must be running in debug monitor mode.
 */

int arm_install_hw_watchpoint(int i, u32 addr)
{
	u32 ctrl = 0x117;
	u32 check_value;

	/* Setup the address register. */
	write_wb_reg(ARM_BASE_WVR + i, addr);
	check_value = read_wb_reg(ARM_BASE_WVR + i);
	if (check_value != addr)
	{
		pr_warn("fail to set WVR[%d] addr:0x%x check_value:0x%x\n", i, addr, check_value);
		return -1;
	}

	/* Setup the control register. */
	write_wb_reg(ARM_BASE_WCR + i, ctrl);
	check_value = read_wb_reg(ARM_BASE_WCR + i);
	if (check_value != ctrl)
	{
		pr_warn("fail to set WCR[%d] ctrl:0x%x check_value:0x%x\n", i, ctrl, check_value);
		return -1;
	}

	return 0;
}
</code></pre></div></div>

<p>å…¶ä¸­ctrl = 0x117ï¼ˆäºŒè¿›åˆ¶â€­0011 10 10 1â€¬)çš„è§£é‡Šå¦‚ä¸‹ï¼Œä¸»è¦å‚è€ƒ<a href="http://infocenter.arm.com/help/topic/com.arm.doc.100511_0401_10_en/arm_cortexa9_trm_100511_0401_10_en.pdf">ã€ŠARMÂ® CortexÂ®-A9 Technical Reference Manualã€‹</a> 10.5.4(Watchpoint Control Registers) è¿™ä¸€èŠ‚ï¼š</p>
<ol>
  <li>æœ€ä½ä½çš„1è¡¨ç¤ºå¼€å¯WatchpointåŠŸèƒ½</li>
  <li>å†å‘ä¸Šçš„10ä»£è¡¨ä»…ç›‘æ§ç”¨æˆ·æ¨¡å¼ä¸‹å¯¹è¯¥å†…å­˜åŒºåŸŸçš„æ“ä½œ</li>
  <li>å†å‘ä¸Šçš„10ä»£è¡¨ä»…ç›‘æ§å¾€è¯¥å†…å­˜åŒºåŸŸçš„å†™å…¥æ“ä½œ</li>
  <li>Watchpointç›‘æ§çš„è™šæ‹Ÿå†…å­˜åœ°å€ä¸ºå­—å¯¹é½çš„ï¼ˆ32ä½ç³»ç»Ÿä¸º4å­—èŠ‚å¯¹é½ï¼‰ï¼Œæ¯ä¸ªWatchpointæœ€å¤§ç›‘æ§é•¿åº¦ä¸º4å­—èŠ‚ï¼ˆ32ä½ç³»ç»Ÿï¼‰ã€‚ä½†æ˜¯å¦‚æœä»…ä»…æƒ³ç›‘æ§1ä¸ªå­—èŠ‚æˆ–è€…2ä¸ªå­—èŠ‚å‘¢ï¼Ÿæœ€å‰é¢çš„å››ä¸ªæ¯”ç‰¹0011å°±æ˜¯ç”¨æ¥åšè¿™ä¸ªäº‹æƒ…çš„ã€‚ä¸Šé¢çš„0011ä»£è¡¨ä»…ç›‘æ§addrå¼€å§‹çš„2ä¸ªå­—èŠ‚ã€‚å¦‚æœåªæƒ³ç›‘æ§æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå‰4æ¯”ç‰¹å¯ä»¥å†™ä¸º0001ã€‚</li>
</ol>

<p>ä¸Šé¢ä»£ç ä¸­å¼•ç”¨å‡½æ•°/å®å®šä¹‰å¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define isb() __asm__ __volatile__ ("" : : : "memory")

#define READ_WB_REG_CASE(OP2, M, VAL)			\
	case ((OP2 &lt;&lt; 4) + M):				\
		ARM_DBG_READ(c0, c ## M, OP2, VAL);	\
		break

#define WRITE_WB_REG_CASE(OP2, M, VAL)			\
	case ((OP2 &lt;&lt; 4) + M):				\
		ARM_DBG_WRITE(c0, c ## M, OP2, VAL);	\
		break

#define GEN_READ_WB_REG_CASES(OP2, VAL)		\
	READ_WB_REG_CASE(OP2, 0, VAL);		\
	READ_WB_REG_CASE(OP2, 1, VAL);		\
	READ_WB_REG_CASE(OP2, 2, VAL);		\
	READ_WB_REG_CASE(OP2, 3, VAL);		\
	READ_WB_REG_CASE(OP2, 4, VAL);		\
	READ_WB_REG_CASE(OP2, 5, VAL);		\
	READ_WB_REG_CASE(OP2, 6, VAL);		\
	READ_WB_REG_CASE(OP2, 7, VAL);		\
	READ_WB_REG_CASE(OP2, 8, VAL);		\
	READ_WB_REG_CASE(OP2, 9, VAL);		\
	READ_WB_REG_CASE(OP2, 10, VAL);		\
	READ_WB_REG_CASE(OP2, 11, VAL);		\
	READ_WB_REG_CASE(OP2, 12, VAL);		\
	READ_WB_REG_CASE(OP2, 13, VAL);		\
	READ_WB_REG_CASE(OP2, 14, VAL);		\
	READ_WB_REG_CASE(OP2, 15, VAL)

#define GEN_WRITE_WB_REG_CASES(OP2, VAL)	\
	WRITE_WB_REG_CASE(OP2, 0, VAL);		\
	WRITE_WB_REG_CASE(OP2, 1, VAL);		\
	WRITE_WB_REG_CASE(OP2, 2, VAL);		\
	WRITE_WB_REG_CASE(OP2, 3, VAL);		\
	WRITE_WB_REG_CASE(OP2, 4, VAL);		\
	WRITE_WB_REG_CASE(OP2, 5, VAL);		\
	WRITE_WB_REG_CASE(OP2, 6, VAL);		\
	WRITE_WB_REG_CASE(OP2, 7, VAL);		\
	WRITE_WB_REG_CASE(OP2, 8, VAL);		\
	WRITE_WB_REG_CASE(OP2, 9, VAL);		\
	WRITE_WB_REG_CASE(OP2, 10, VAL);	\
	WRITE_WB_REG_CASE(OP2, 11, VAL);	\
	WRITE_WB_REG_CASE(OP2, 12, VAL);	\
	WRITE_WB_REG_CASE(OP2, 13, VAL);	\
	WRITE_WB_REG_CASE(OP2, 14, VAL);	\
	WRITE_WB_REG_CASE(OP2, 15, VAL)

static u32 read_wb_reg(int n)
{
	u32 val = 0;

	switch (n) {
	GEN_READ_WB_REG_CASES(ARM_OP2_BVR, val);
	GEN_READ_WB_REG_CASES(ARM_OP2_BCR, val);
	GEN_READ_WB_REG_CASES(ARM_OP2_WVR, val);
	GEN_READ_WB_REG_CASES(ARM_OP2_WCR, val);
	default:
		pr_warn("attempt to read from unknown breakpoint register %d\n", n);
	}

	return val;
}

static void write_wb_reg(int n, u32 val)
{
	switch (n) {
	GEN_WRITE_WB_REG_CASES(ARM_OP2_BVR, val);
	GEN_WRITE_WB_REG_CASES(ARM_OP2_BCR, val);
	GEN_WRITE_WB_REG_CASES(ARM_OP2_WVR, val);
	GEN_WRITE_WB_REG_CASES(ARM_OP2_WCR, val);
	default:
		pr_warn("attempt to write to unknown breakpoint register %d\n", n);
	}
	isb();
}
</code></pre></div></div>

<p><strong>æ³¨æ„ï¼šcacheæ“ä½œä¸ä¼šäº§ç”Ÿwatchpointäº‹ä»¶(Cache maintenance operations do not generate watchpoint events)</strong></p>

<p>æœ‰äº†ä¸Šé¢çš„arm_install_hw_watchpointå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®éœ€è¦åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€çš„å¯¹ç‰¹å®šåœ°å€æ·»åŠ ç›‘æ§ï¼Œçœ‹çœ‹è°è¸©äº†å†…å­˜ã€‚</p>

<h2 id="å››å‚è€ƒèµ„æ–™">å››ã€å‚è€ƒèµ„æ–™</h2>

<ol>
  <li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.100511_0401_10_en/arm_cortexa9_trm_100511_0401_10_en.pdf">ã€ŠARMÂ® CortexÂ®-A9 Technical Reference Manualã€‹</a></li>
  <li><a href="https://static.docs.arm.com/ddi0406/c/DDI0406C_C_arm_architecture_reference_manual.pdf">ã€ŠARMÂ® Architecture Reference Manual
ARMv7-A and ARMv7-R editionã€‹</a></li>
  <li><a href="https://sourceware.org/gdb/wiki/Internals%20Watchpoints">https://sourceware.org/gdb/wiki/Internals%20Watchpoints</a></li>
  <li><a href="https://github.com/torvalds/linux/blob/9331b6740f86163908de69f4008e434fe0c27691/arch/arm/kernel/hw_breakpoint.c">hw_breakpoint.c</a></li>
</ol>
:ET