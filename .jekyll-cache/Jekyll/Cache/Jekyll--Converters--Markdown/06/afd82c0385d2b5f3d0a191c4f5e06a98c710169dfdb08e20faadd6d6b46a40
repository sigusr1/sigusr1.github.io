I"V<ul id="markdown-toc">
  <li><a href="#ä¸€æ ˆ" id="markdown-toc-ä¸€æ ˆ">ä¸€ã€æ ˆ</a></li>
  <li><a href="#äºŒé¢„å¤‡çŸ¥è¯†" id="markdown-toc-äºŒé¢„å¤‡çŸ¥è¯†">äºŒã€é¢„å¤‡çŸ¥è¯†</a></li>
  <li><a href="#ä¸‰å®éªŒç¯å¢ƒ" id="markdown-toc-ä¸‰å®éªŒç¯å¢ƒ">ä¸‰ã€å®éªŒç¯å¢ƒ</a></li>
  <li><a href="#å››å±€éƒ¨å˜é‡" id="markdown-toc-å››å±€éƒ¨å˜é‡">å››ã€å±€éƒ¨å˜é‡</a>    <ul>
      <li><a href="#1è‡ªåŠ¨åˆ†é…å†…å­˜" id="markdown-toc-1è‡ªåŠ¨åˆ†é…å†…å­˜">1ã€è‡ªåŠ¨åˆ†é…å†…å­˜</a></li>
      <li><a href="#2ä½¿ç”¨å±€éƒ¨å˜é‡" id="markdown-toc-2ä½¿ç”¨å±€éƒ¨å˜é‡">2ã€ä½¿ç”¨å±€éƒ¨å˜é‡</a></li>
      <li><a href="#3è‡ªåŠ¨é”€æ¯å†…å­˜" id="markdown-toc-3è‡ªåŠ¨é”€æ¯å†…å­˜">3ã€è‡ªåŠ¨é”€æ¯å†…å­˜</a></li>
    </ul>
  </li>
  <li><a href="#äº”å¯¹æ ˆçš„è¿›ä¸€æ­¥æ¢ç©¶" id="markdown-toc-äº”å¯¹æ ˆçš„è¿›ä¸€æ­¥æ¢ç©¶">äº”ã€å¯¹æ ˆçš„è¿›ä¸€æ­¥æ¢ç©¶</a>    <ul>
      <li><a href="#1å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–" id="markdown-toc-1å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–">1ã€å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–</a></li>
      <li><a href="#2å‡½æ•°è¿”å›æœºåˆ¶retæŒ‡ä»¤" id="markdown-toc-2å‡½æ•°è¿”å›æœºåˆ¶retæŒ‡ä»¤">2ã€å‡½æ•°è¿”å›æœºåˆ¶ï¼šretæŒ‡ä»¤</a></li>
    </ul>
  </li>
  <li><a href="#å…­é€šè¿‡å¯„å­˜å™¨æ¢ç´¢æ ˆå†…å®¹" id="markdown-toc-å…­é€šè¿‡å¯„å­˜å™¨æ¢ç´¢æ ˆå†…å®¹">å…­ã€é€šè¿‡å¯„å­˜å™¨æ¢ç´¢æ ˆå†…å®¹</a>    <ul>
      <li><a href="#1è®¿é—®å±€éƒ¨å˜é‡" id="markdown-toc-1è®¿é—®å±€éƒ¨å˜é‡">1ã€è®¿é—®å±€éƒ¨å˜é‡</a></li>
      <li><a href="#2è®¿é—®å¯„å­˜å™¨rbpçš„å†å²å€¼" id="markdown-toc-2è®¿é—®å¯„å­˜å™¨rbpçš„å†å²å€¼">2ã€è®¿é—®å¯„å­˜å™¨rbpçš„å†å²å€¼</a></li>
      <li><a href="#3è®¿é—®å‡½æ•°è¿”å›åœ°å€" id="markdown-toc-3è®¿é—®å‡½æ•°è¿”å›åœ°å€">3ã€è®¿é—®å‡½æ•°è¿”å›åœ°å€</a></li>
      <li><a href="#4ç¨‹åºæ‰§è¡Œç»“æœ" id="markdown-toc-4ç¨‹åºæ‰§è¡Œç»“æœ">4ã€ç¨‹åºæ‰§è¡Œç»“æœ</a></li>
    </ul>
  </li>
  <li><a href="#ä¸ƒæ ˆå…¥ä¾µ" id="markdown-toc-ä¸ƒæ ˆå…¥ä¾µ">ä¸ƒã€æ ˆå…¥ä¾µ</a></li>
  <li><a href="#å…«ç»§ç»­é˜…è¯»" id="markdown-toc-å…«ç»§ç»­é˜…è¯»">å…«ã€ç»§ç»­é˜…è¯»</a></li>
  <li><a href="#ä¹åŸæ–‡é“¾æ¥" id="markdown-toc-ä¹åŸæ–‡é“¾æ¥">ä¹ã€åŸæ–‡é“¾æ¥</a></li>
</ul>

<p>è¿™æ˜¯è™šæ‹Ÿå†…å­˜ç³»åˆ—æ–‡ç« çš„ç¬¬äº”ç¯‡ï¼Œä¹Ÿæ˜¯æœ€åä¸€ç¯‡ï¼Œç›®æ ‡æ˜¯ä»¥ä¸åŒçš„æ–¹å¼åœ¨å®è·µä¸­å­¦ä¹ ä¸€äº›è®¡ç®—æœºåŸºç¡€çŸ¥è¯†ã€‚</p>

<p>å‰å‡ ç¯‡å¯ä»¥é€šè¿‡ä¸‹é¢çš„é“¾æ¥æŸ¥çœ‹ï¼š</p>

<ul>
  <li>ç¬¬ä¸€ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/12/Virtual_Memory_C_strings_proc/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸€ç¯‡:C strings &amp; /proc</a></li>
  <li>ç¬¬äºŒç¯‡:<a href="http://blog.coderhuo.tech/2017/10/15/Virtual_Memory_python_bytes/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬äºŒç¯‡:Python å­—èŠ‚</a></li>
  <li>ç¬¬ä¸‰ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/16/Virtual_Memory_drawing_VM_diagram/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸‰ç¯‡:ä¸€æ­¥ä¸€æ­¥ç”»è™šæ‹Ÿå†…å­˜å›¾</a></li>
  <li>ç¬¬å››ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/18/Virtual_Memory_malloc_and_heap/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬å››ç¯‡:malloc, heap &amp; the program break</a></li>
</ul>

<h2 id="ä¸€æ ˆ">ä¸€ã€æ ˆ</h2>

<p>ä»<a href="http://blog.coderhuo.tech/2017/10/16/Virtual_Memory_drawing_VM_diagram/">ã€Šè™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸‰ç¯‡:ä¸€æ­¥ä¸€æ­¥ç”»è™šæ‹Ÿå†…å­˜å›¾ã€‹</a>è¿™ä¸€ç« æˆ‘ä»¬äº†è§£åˆ°ï¼Œæ ˆæ˜¯ä»é«˜åœ°å€å‘ä½åœ°å€ç”Ÿé•¿çš„ã€‚ä½†å®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿå®ƒæ˜¯å¦‚ä½•ç¿»è¯‘æˆæ±‡ç¼–ä»£ç çš„ï¼Ÿå¯„å­˜å™¨æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿ</p>

<p>æœ¬ç« æˆ‘ä»¬å°†æ·±å…¥å­¦ä¹ æ ˆæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥åŠå±€éƒ¨å˜é‡æ˜¯å¦‚ä½•è‡ªåŠ¨ç”³è¯·ã€é‡Šæ”¾çš„ã€‚</p>

<p>ä¸€æ—¦æŒæ¡äº†è¿™äº›çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥æç‚¹äº‹æƒ…ï¼Œæ¯”å¦‚åŠ«æŒç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚</p>

<p>å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>

<p><em>æ³¨æ„ï¼šæˆ‘ä»¬å³å°†å­¦ä¹ çš„æ˜¯ç”¨æˆ·æ€çš„æ ˆï¼Œè€Œä¸æ˜¯å†…æ ¸æ€çš„æ ˆã€‚</em></p>

<h2 id="äºŒé¢„å¤‡çŸ¥è¯†">äºŒã€é¢„å¤‡çŸ¥è¯†</h2>
<p>å­¦ä¹ æœ¬ç« å†…å®¹ï¼Œéœ€è¦æŒæ¡Cè¯­è¨€çš„åŸºç¡€çŸ¥è¯†ï¼Œç‰¹åˆ«æ˜¯æŒ‡é’ˆç›¸å…³çŸ¥è¯†ã€‚</p>

<h2 id="ä¸‰å®éªŒç¯å¢ƒ">ä¸‰ã€å®éªŒç¯å¢ƒ</h2>
<p>æ‰€æœ‰çš„è„šæœ¬å’Œç¨‹åºéƒ½åœ¨ä¸‹é¢çš„ç¯å¢ƒä¸­æµ‹è¯•è¿‡ï¼š</p>

<ul>
  <li>Ubuntu
    <ul>
      <li>Linux ubuntu 4.4.0-31-generic #50~14.04.1-Ubuntu SMP Wed Jul 13 01:07:32 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux</li>
    </ul>
  </li>
  <li>gcc
    <ul>
      <li>gcc (Ubuntu 4.8.4-2ubuntu1~14.04.3) 4.8.4</li>
    </ul>
  </li>
  <li>objdump
    <ul>
      <li>GNU objdump (GNU Binutils for Ubuntu) 2.2</li>
    </ul>
  </li>
</ul>

<p><strong>æœ¬æ–‡æ¶‰åŠçš„å†…å®¹åœ¨ä¸Šé¢çš„ç¯å¢ƒä¸­éƒ½æ˜¯OKçš„ï¼Œä½†åœ¨å…¶ä»–ç¯å¢ƒä¸­å¯èƒ½ä¼šå­˜åœ¨å·®å¼‚ã€‚</strong></p>

<h2 id="å››å±€éƒ¨å˜é‡">å››ã€å±€éƒ¨å˜é‡</h2>
<h3 id="1è‡ªåŠ¨åˆ†é…å†…å­˜">1ã€è‡ªåŠ¨åˆ†é…å†…å­˜</h3>

<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œå®ƒåªæœ‰ä¸€ä¸ªmainå‡½æ•°ï¼Œmainå‡½æ•°ä¸­åªæœ‰ä¸€ä¸ªå˜é‡ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;

int main(void)
{
	int a;

	a = 972;
	printf("a = %d\n", a);
	return (0);
}
</code></pre></div></div>

<p>æˆ‘ä»¬å…ˆç¼–è¯‘è¿™ä¸ªç¨‹åºï¼Œç„¶åç”¨<code class="highlighter-rouge">objdump</code>åæ±‡ç¼–ç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åº:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ gcc 0-main.c
holberton$ objdump -d -j .text -M intel a.out
</code></pre></div></div>

<p><code class="highlighter-rouge">main</code>å‡½æ•°å¯¹åº”çš„åæ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>000000000040052d &lt;main&gt;:
  40052d:       55                      push   rbp
  40052e:       48 89 e5                mov    rbp,rsp
  400531:       48 83 ec 10             sub    rsp,0x10
  400535:       c7 45 fc cc 03 00 00    mov    DWORD PTR [rbp-0x4],0x3cc
  40053c:       8b 45 fc                mov    eax,DWORD PTR [rbp-0x4]
  40053f:       89 c6                   mov    esi,eax
  400541:       bf e4 05 40 00          mov    edi,0x4005e4
  400546:       b8 00 00 00 00          mov    eax,0x0
  40054b:       e8 c0 fe ff ff          call   400410 &lt;printf@plt&gt;
  400550:       b8 00 00 00 00          mov    eax,0x0
  400555:       c9                      leave  
  400556:       c3                      ret    
  400557:       66 0f 1f 84 00 00 00    nop    WORD PTR [rax+rax*1+0x0]
  40055e:       00 00   
</code></pre></div></div>

<p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨<code class="highlighter-rouge">main</code>å‡½æ•°çš„å‰3è¡Œæ±‡ç¼–ä»£ç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>000000000040052d &lt;main&gt;:
  40052d:       55                      push   rbp
  40052e:       48 89 e5                mov    rbp,rsp
  400531:       48 83 ec 10             sub    rsp,0x10
</code></pre></div></div>

<p>å‰ä¸¤è¡Œæ“ä½œäº†å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>å’Œ<code class="highlighter-rouge">rsp</code>ã€‚è¿™ä¸¤ä¸ªéƒ½æ˜¯å…·æœ‰ç‰¹æ®Šç”¨é€”çš„å¯„å­˜å™¨ï¼Œ<code class="highlighter-rouge">rbp</code>æ˜¯æŒ‡å‘å½“å‰æ ˆå¸§åº•éƒ¨çš„å¯„å­˜å™¨ï¼Œ<code class="highlighter-rouge">rsp</code>æ˜¯æŒ‡å‘å½“å‰æ ˆå¸§é¡¶éƒ¨çš„å¯„å­˜å™¨ã€‚</p>

<p>æˆ‘ä»¬é€æ­¥å±•ç¤ºä¸‹è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆã€‚</p>

<p>åˆšè¿›å…¥<code class="highlighter-rouge">main</code>å‡½æ•°è¿˜æœªæ‰§è¡Œä»»ä½•æŒ‡ä»¤çš„æ—¶å€™ï¼Œæ ˆçŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_init_status.png" alt="mainå‡½æ•°æ ˆåˆå§‹çŠ¶æ€" /></p>

<p>æŒ‡ä»¤<code class="highlighter-rouge">push rbp</code>æŠŠå¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>çš„å€¼å­˜åœ¨äº†æ ˆä¸Šï¼Œå¹¶ä½¿æ ˆå‘ä¸‹ç”Ÿé•¿ï¼ˆå³æ ˆé¡¶ä¸‹ç§»ï¼ŒåŒæ—¶å¯„å­˜å™¨<code class="highlighter-rouge">rsp</code>æŒ‡å‘æ–°çš„æ ˆé¡¶ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_after_push.png" alt="rbpå…¥æ ˆåçš„æ ˆçŠ¶æ€" /></p>

<p>æŒ‡ä»¤<code class="highlighter-rouge">mov rbp, rsp</code>å°†å¯„å­˜å™¨<code class="highlighter-rouge">rsp</code>çš„å€¼æ‹·è´åˆ°å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>ï¼Œç°åœ¨äºŒè€…éƒ½æŒ‡å‘æ–°æ ˆå¸§çš„æ ˆé¡¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_after_mov.png" alt="rbpã€rspå‡æŒ‡å‘æ ˆé¡¶" /></p>

<p>æŒ‡ä»¤<code class="highlighter-rouge">sub rsp, 0x10</code>åœ¨æ ˆä¸Šä¸ºå±€éƒ¨å˜é‡å¼€è¾Ÿäº†å­˜å‚¨ç©ºé—´ï¼Œå³ä»<code class="highlighter-rouge">rbp</code>æ‰€æŒ‡åœ°å€åˆ°<code class="highlighter-rouge">rsp</code>æ‰€æŒ‡åœ°å€çš„å†…å­˜åŒºåŸŸï¼ˆ16ä¸ªå­—èŠ‚ï¼‰ï¼Œè¶³ä»¥å­˜å‚¨<code class="highlighter-rouge">int</code>å‹å˜é‡<code class="highlighter-rouge">a</code>ã€‚è¿™å—å†…å­˜ç©ºé—´è¢«ç§°ä¸º<strong>æ ˆå¸§</strong>ã€‚ä»»ä½•ä¸€ä¸ªå®šä¹‰äº†å±€éƒ¨å˜é‡çš„å‡½æ•°ï¼Œéƒ½ä¼šä½¿ç”¨æ ˆå¸§æ¥å­˜å‚¨è¿™äº›å±€éƒ¨å˜é‡ã€‚</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_after_create_space.png" alt="å¼€è¾Ÿå†…å­˜ç©ºé—´åçš„æ ˆçŠ¶æ€" /></p>

<h3 id="2ä½¿ç”¨å±€éƒ¨å˜é‡">2ã€ä½¿ç”¨å±€éƒ¨å˜é‡</h3>

<p><code class="highlighter-rouge">main</code>å‡½æ•°å¯¹åº”æ±‡ç¼–ä»£ç çš„ç¬¬å››è¡Œå¦‚ä¸‹æ‰€ç¤º:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  400535:       c7 45 fc cc 03 00 00    mov    DWORD PTR [rbp-0x4],0x3cc
</code></pre></div></div>

<p><code class="highlighter-rouge">0x3cc</code>æ˜¯åè¿›åˆ¶æ•°<code class="highlighter-rouge">972</code>çš„åå…­è¿›åˆ¶è¡¨ç¤ºã€‚è¿™å¥æ±‡ç¼–ä»£ç å¯¹åº”çš„Cä»£ç å¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a = 972;
</code></pre></div></div>

<p>æŒ‡ä»¤<code class="highlighter-rouge">mov DWORD PTR [rbp-0x4],0x3cc</code>æŠŠ<code class="highlighter-rouge">rbp - 4</code>æ‰€æŒ‡å†…å­˜åŒºåŸŸèµ‹å€¼ä¸º<code class="highlighter-rouge">972</code>ã€‚<code class="highlighter-rouge">[rbp - 4]</code>æ­¤æ—¶è¡¨ç¤ºçš„å°±æ˜¯å±€éƒ¨å˜é‡<code class="highlighter-rouge">a</code>ã€‚è®¡ç®—æœºå¹¶ä¸çŸ¥é“ä»£ç ä¸­æ‰€ç”¨å˜é‡çš„åå­—ï¼Œå®ƒæŒ‡å‘æ ˆä¸Šä¸åŒçš„å†…å­˜åŒºåŸŸæ¥è¡¨ç¤ºä¸åŒçš„å˜é‡ã€‚</p>

<p>ä¸‹å›¾æ˜¯èµ‹å€¼æ“ä½œåæ ˆå’Œå¯„å­˜å™¨çš„çŠ¶æ€ï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_after_assign.png" alt="èµ‹å€¼åæ ˆå’Œå¯„å­˜å™¨çš„çŠ¶æ€" /></p>

<h3 id="3è‡ªåŠ¨é”€æ¯å†…å­˜">3ã€è‡ªåŠ¨é”€æ¯å†…å­˜</h3>

<p><code class="highlighter-rouge">main</code>å‡½æ•°ç»“æŸçš„æ—¶å€™è°ƒç”¨äº†<code class="highlighter-rouge">leave</code>æŒ‡ä»¤ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400555:       c9                      leave  
</code></pre></div></div>

<p><code class="highlighter-rouge">leave</code>æŒ‡ä»¤å®ç°äº†æ ˆæ”¶ç¼©çš„åŠŸèƒ½ï¼Œè¯¥æŒ‡ä»¤é¦–å…ˆæŠŠ<code class="highlighter-rouge">rbp</code>çš„å€¼èµ‹ç»™<code class="highlighter-rouge">rsp</code>ï¼ˆ<em>è¯‘è€…æ³¨ï¼šæ ˆé¡¶æŒ‡å‘ä¸Šä¸€ä¸ªæ ˆå¸§çš„æ ˆé¡¶</em>ï¼‰ï¼Œç„¶åæ‰§è¡Œå‡ºæ ˆæ“ä½œï¼ŒæŠŠæ ˆé¡¶å­˜å‚¨çš„å€¼èµ‹ç»™<code class="highlighter-rouge">rbp</code>ï¼ˆ<em>è¯‘è€…æ³¨:å½“å‰æ ˆé¡¶å­˜å‚¨çš„æ˜¯<code class="highlighter-rouge">rbp</code>çš„å†å²å€¼ï¼Œå‡ºæ ˆæ“ä½œå°†<code class="highlighter-rouge">rbp</code>æ¢å¤ä¸ºè°ƒç”¨<code class="highlighter-rouge">main</code>å‡½æ•°å‰çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘ä¸Šä¸€ä¸ªæ ˆå¸§çš„åº•éƒ¨</em>ï¼‰ã€‚æ‰€ä»¥ï¼Œæœ¬æŒ‡ä»¤è¾¾åˆ°äº†ä¸¤ä¸ªç›®çš„ï¼š</p>

<ul>
  <li>å±€éƒ¨å˜é‡å ç”¨çš„å†…å­˜ç©ºé—´è¢«é‡Šæ”¾</li>
  <li>æ ˆã€å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>å’Œ<code class="highlighter-rouge">rsp</code>å‡æ¢å¤æˆè°ƒç”¨<code class="highlighter-rouge">main</code>å‡½æ•°å‰çš„çŠ¶æ€</li>
</ul>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_after_leave.png" alt="leaveåæ ˆå’Œå¯„å­˜å™¨çš„çŠ¶æ€1" /></p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/main_stack_after_leave2.png" alt="leaveåæ ˆå’Œå¯„å­˜å™¨çš„çŠ¶æ€2" /></p>

<h2 id="äº”å¯¹æ ˆçš„è¿›ä¸€æ­¥æ¢ç©¶">äº”ã€å¯¹æ ˆçš„è¿›ä¸€æ­¥æ¢ç©¶</h2>
<h3 id="1å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–">1ã€å±€éƒ¨å˜é‡ä¸ºä»€ä¹ˆè¦åˆå§‹åŒ–</h3>

<p>å½“æ ˆä¸Šçš„å±€éƒ¨å˜é‡è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œä»–ä»¬å¹¶æœªè¢«å®Œå…¨æ¸…ç†ã€‚ä»–ä»¬æ‰€å å†…å­˜åŒºåŸŸï¼Œå¡«å……çš„ä»ç„¶æ˜¯åŸæ¥çš„æ•°å€¼ï¼Œè€Œè¿™ä¸€åŒºåŸŸåœ¨æ¥ä¸‹æ¥å¯èƒ½è¢«å…¶ä»–å‡½æ•°ç”¨åˆ°ã€‚æ‰€ä»¥ï¼Œç¨‹åºä¸­çš„å˜é‡ä¸€å®šè¦åˆå§‹åŒ–ï¼Œå¦åˆ™ï¼Œä»–ä»¬çš„å€¼å–å†³äºæ‰€ç”¨æ ˆå†…å­˜åŒºåŸŸçš„å½“å‰çŠ¶æ€ï¼Œæ˜¯ä¸ç¡®å®šçš„ã€‚</p>

<p>ä¸‹é¢çš„ä¾‹å­å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡åœ¨ä½¿ç”¨å‰å¿…é¡»åˆå§‹åŒ–ï¼ŒåŠå…¶èƒŒåçš„åŸç†ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;

void func1(void)
{
     int a;
     int b;
     int c;

     a = 98;
     b = 972;
     c = a + b;
     printf("a = %d, b = %d, c = %d\n", a, b, c);
}

void func2(void)
{
     int a;
     int b;
     int c;

     printf("a = %d, b = %d, c = %d\n", a, b, c);
}

int main(void)
{
	func1();
	func2();
	return (0);
}
</code></pre></div></div>

<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œ<code class="highlighter-rouge">func2</code>ä¸­å¹¶æœªç»™å˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>èµ‹å€¼ï¼Œæˆ‘ä»¬çœ‹ä¸‹ç¼–è¯‘è¿è¡Œè¿™æ®µä»£ç ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ gcc 1-main.c &amp;&amp; ./a.out 
a = 98, b = 972, c = 1070
a = 98, b = 972, c = 1070
holberton$ 
</code></pre></div></div>

<p>ä¸å¯æ€è®®ï¼Œ<code class="highlighter-rouge">func2</code>ä¸­çš„å˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>æ‰“å°å‡ºæ¥çš„æ•°å€¼å’Œ<code class="highlighter-rouge">func1</code>ä¸€æ¨¡ä¸€æ ·ï¼è¿™æ˜¯ç”±äºæ ˆçš„å·¥ä½œåŸç†å†³å®šçš„ã€‚è¿™ä¸¤ä¸ªå‡½æ•°å±€éƒ¨å˜é‡çš„ä¸ªæ•°ä¸€æ ·ï¼Œç±»å‹ä¸€æ ·ï¼Œé¡ºåºä¹Ÿä¸€æ ·ï¼Œè¿™å¯¼è‡´å®ƒä»¬çš„æ ˆå¸§ä¹Ÿä¸€æ ·ã€‚<code class="highlighter-rouge">func1</code>é€€å‡ºçš„æ—¶å€™ï¼Œä»…ä»…æ˜¯æ ˆæ”¶ç¼©ï¼Œå±€éƒ¨å˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>æ‰€åœ¨çš„å†…å­˜åŒºåŸŸå¹¶æœªè¢«æ¸…ç†ï¼Œå…¶å€¼ä»ç„¶ä¸º<code class="highlighter-rouge">func1</code>é€€å‡ºæ—¶çš„å€¼ã€‚å› æ­¤ï¼Œå½“<code class="highlighter-rouge">func2</code>è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®ƒçš„æ ˆå¸§å’ŒåŸæ¥<code class="highlighter-rouge">func1</code>çš„æ ˆå¸§å®Œå…¨é‡åˆï¼Œ<code class="highlighter-rouge">func2</code>ä¸­å±€éƒ¨å˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>çš„å€¼å°±æ˜¯<code class="highlighter-rouge">func1</code>é€€å‡ºæ—¶å±€éƒ¨å˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>çš„å€¼ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥ä»æ±‡ç¼–ä»£ç è¯æ˜è¿™ä¸€æ¨è®ºã€‚é¦–å…ˆåæ±‡ç¼–ä¸Šé¢çš„å¯æ‰§è¡Œç¨‹åºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ objdump -d -j .text -M intel a.out
</code></pre></div></div>

<p>å¯¹åº”çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>000000000040052d &lt;func1&gt;:
  40052d:       55                      push   rbp
  40052e:       48 89 e5                mov    rbp,rsp
  400531:       48 83 ec 10             sub    rsp,0x10
  400535:       c7 45 f4 62 00 00 00    mov    DWORD PTR [rbp-0xc],0x62
  40053c:       c7 45 f8 cc 03 00 00    mov    DWORD PTR [rbp-0x8],0x3cc
  400543:       8b 45 f8                mov    eax,DWORD PTR [rbp-0x8]
  400546:       8b 55 f4                mov    edx,DWORD PTR [rbp-0xc]
  400549:       01 d0                   add    eax,edx
  40054b:       89 45 fc                mov    DWORD PTR [rbp-0x4],eax
  40054e:       8b 4d fc                mov    ecx,DWORD PTR [rbp-0x4]
  400551:       8b 55 f8                mov    edx,DWORD PTR [rbp-0x8]
  400554:       8b 45 f4                mov    eax,DWORD PTR [rbp-0xc]
  400557:       89 c6                   mov    esi,eax
  400559:       bf 34 06 40 00          mov    edi,0x400634
  40055e:       b8 00 00 00 00          mov    eax,0x0
  400563:       e8 a8 fe ff ff          call   400410 &lt;printf@plt&gt;
  400568:       c9                      leave  
  400569:       c3                      ret    

000000000040056a &lt;func2&gt;:
  40056a:       55                      push   rbp
  40056b:       48 89 e5                mov    rbp,rsp
  40056e:       48 83 ec 10             sub    rsp,0x10
  400572:       8b 4d fc                mov    ecx,DWORD PTR [rbp-0x4]
  400575:       8b 55 f8                mov    edx,DWORD PTR [rbp-0x8]
  400578:       8b 45 f4                mov    eax,DWORD PTR [rbp-0xc]
  40057b:       89 c6                   mov    esi,eax
  40057d:       bf 34 06 40 00          mov    edi,0x400634
  400582:       b8 00 00 00 00          mov    eax,0x0
  400587:       e8 84 fe ff ff          call   400410 &lt;printf@plt&gt;
  40058c:       c9                      leave  
  40058d:       c3                      ret  

000000000040058e &lt;main&gt;:
  40058e:       55                      push   rbp
  40058f:       48 89 e5                mov    rbp,rsp
  400592:       e8 96 ff ff ff          call   40052d &lt;func1&gt;
  400597:       e8 ce ff ff ff          call   40056a &lt;func2&gt;
  40059c:       b8 00 00 00 00          mov    eax,0x0
  4005a1:       5d                      pop    rbp
  4005a2:       c3                      ret    
  4005a3:       66 2e 0f 1f 84 00 00    nop    WORD PTR cs:[rax+rax*1+0x0]
  4005aa:       00 00 00 
  4005ad:       0f 1f 00                nop    DWORD PTR [rax]
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ ˆå¸§å½¢æˆçš„æ–¹å¼æ˜¯ä¸€è‡´çš„ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œç”±äº<code class="highlighter-rouge">func1</code>å’Œ<code class="highlighter-rouge">func2</code>ä¸¤ä¸ªå‡½æ•°çš„å±€éƒ¨å˜é‡ä¸€æ ·ï¼Œæ‰€ä»¥å½¢æˆçš„æ ˆå¸§å¤§å°ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚è¿™ä»ä¸‹é¢å¼€è¾Ÿæ ˆå¸§ç›¸å…³çš„æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡ºæ¥ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>push   rbp
mov    rbp,rsp
sub    rsp,0x10
</code></pre></div></div>

<p>åœ¨<code class="highlighter-rouge">func1</code>å’Œ<code class="highlighter-rouge">func2</code>è¿™ä¸¤ä¸ªå‡½æ•°ä¸­ï¼Œå˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>çš„è§£ææ–¹å¼æ˜¯ä¸€æ ·çš„ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">a</code>ä½äº<code class="highlighter-rouge">rbp - 0xc</code>æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸ</li>
  <li><code class="highlighter-rouge">b</code>ä½äº<code class="highlighter-rouge">rbp - 0x8</code>æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸ</li>
  <li><code class="highlighter-rouge">c</code>ä½äº<code class="highlighter-rouge">rbp - 0x4</code>æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸ</li>
</ul>

<p>æ³¨æ„ï¼Œè¿™å‡ ä¸ªå˜é‡åœ¨æ ˆä¸Šçš„æ’åˆ—é¡ºåºå’Œä»£ç ä¸­å®šä¹‰çš„é¡ºåºå¹¶ä¸ä¸€è‡´ã€‚å®é™…ä¸Šï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®ä¸€å®šçš„è§„åˆ™æ’åˆ—å±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬ä¸åº”è¯¥å¯¹å±€éƒ¨å˜é‡åœ¨æ ˆä¸Šçš„é¡ºåºåšä»»ä½•å‡è®¾ã€‚</p>

<p>å‡½æ•°<code class="highlighter-rouge">func1</code>è¿”å›å‰çš„æ ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/lacal_var_befor_func1_leave.png" alt="å‡½æ•°func1è¿”å›å‰çš„æ ˆç¤ºæ„å›¾" /></p>

<p>å‡½æ•°<code class="highlighter-rouge">func1</code>è¿”å›çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨æŒ‡ä»¤<code class="highlighter-rouge">leave</code>ã€‚å‰é¢è§£é‡Šè¿‡ï¼Œè¯¥æŒ‡ä»¤ä¼šå¯¼è‡´æ ˆå¸§æ”¶ç¼©ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/lacal_var_after_func1_leave.png" alt="å‡½æ•°func1è¿”å›åçš„æ ˆç¤ºæ„å›¾" /></p>

<p>å½“æˆ‘ä»¬è°ƒç”¨å‡½æ•°<code class="highlighter-rouge">func2</code>æ—¶ï¼Œå®ƒçš„æ ˆå¸§å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå±€éƒ¨å˜é‡çš„å€¼å°±æ˜¯å½“å‰æ ˆä¸Šæ®‹ç•™çš„å€¼ã€‚è¿™å°±æ˜¯<code class="highlighter-rouge">func2</code>ä¸­å˜é‡<code class="highlighter-rouge">a</code>ã€<code class="highlighter-rouge">b</code>ã€<code class="highlighter-rouge">c</code>çš„å€¼å’Œ<code class="highlighter-rouge">func1</code>ä¸€è‡´çš„åŸå› äº†ã€‚</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/lacal_var_when_func2_enter.png" alt="å‡½æ•°func2çš„æ ˆå¸§" /></p>

<h3 id="2å‡½æ•°è¿”å›æœºåˆ¶retæŒ‡ä»¤">2ã€å‡½æ•°è¿”å›æœºåˆ¶ï¼šretæŒ‡ä»¤</h3>

<p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°äº†ï¼Œæ‰€æœ‰çš„ç¤ºä¾‹å‡½æ•°éƒ½æ˜¯ä»¥æŒ‡ä»¤<code class="highlighter-rouge">ret</code>ç»“å°¾ã€‚è¯¥æŒ‡ä»¤ä»æ ˆä¸­å–å‡ºè¿”å›åœ°å€ï¼Œå¹¶ä¸”è·³è½¬åˆ°é‚£é‡Œï¼ˆåœ¨å‡½æ•°è¢«è°ƒç”¨å‰ï¼Œ<code class="highlighter-rouge">call</code>æŒ‡ä»¤å°±å·²ç»æŠŠè¿”å›åœ°å€å…¥æ ˆï¼‰ã€‚è¿™å°±æ˜¯å‡½æ•°è°ƒç”¨çš„å·¥ä½œåŸç†ï¼Œå®ƒå¯ä»¥ç¡®ä¿å‡½æ•°èƒ½å¤Ÿæ­£ç¡®è¿”å›å¹¶æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>

<p>è¿™ä¹ˆè¯´æ¥ï¼Œæ ˆä¸Šå­˜å‚¨çš„ä¸ä»…æœ‰å±€éƒ¨å˜é‡ï¼Œè¿˜æœ‰å‡½æ•°è¿”å›åœ°å€ã€‚</p>

<p>å›åˆ°ä¸Šé¢çš„ä¾‹å­ï¼Œ<code class="highlighter-rouge">main</code>å‡½æ•°è°ƒç”¨<code class="highlighter-rouge">func1</code>çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>400592:       e8 96 ff ff ff          call   40052d &lt;func1&gt;
</code></pre></div></div>

<p>è¯¥æ±‡ç¼–æŒ‡ä»¤å…ˆæŠŠä¸‹ä¸€æ¡æŒ‡ä»¤æ‰€åœ¨çš„å†…å­˜åœ°å€å­˜å‚¨åˆ°æ ˆä¸Šï¼Œç„¶åå†è·³è½¬åˆ°<code class="highlighter-rouge">func1</code>ã€‚è¿™æ ·ï¼Œåœ¨æ‰§è¡Œ<code class="highlighter-rouge">func1</code>çš„æŒ‡ä»¤å‰ï¼Œæ ˆé¡¶åŒ…å«äº†å‡½æ•°<code class="highlighter-rouge">func1</code>è°ƒç”¨å®Œæˆåçš„è¿”å›åœ°å€ï¼Œå¯„å­˜å™¨<code class="highlighter-rouge">rsp</code>æŒ‡å‘è¯¥åŒºåŸŸï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/call_statck.png" alt="callå‰çš„æ ˆå¸§" /></p>

<p>å½“<code class="highlighter-rouge">func1</code>çš„æ ˆå¸§å½¢æˆåï¼Œå®Œæ•´çš„æ ˆå¸§å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/func1_stack.png" alt="func1çš„æ ˆå¸§" /></p>

<h2 id="å…­é€šè¿‡å¯„å­˜å™¨æ¢ç´¢æ ˆå†…å®¹">å…­ã€é€šè¿‡å¯„å­˜å™¨æ¢ç´¢æ ˆå†…å®¹</h2>

<p>ç»“åˆä¸Šé¢ä»‹ç»çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åˆ©ç”¨å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>è®¿é—®å±€éƒ¨å˜é‡ï¼ˆä¸æ˜¯é€šè¿‡å˜é‡åï¼‰ï¼Œä»¥åŠæ ˆä¸Šä¿å­˜çš„å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>çš„å†å²å€¼ã€å‡½æ•°è¿”å›åœ°å€ã€‚</p>

<p>ä¸‹é¢çš„ä»£ç å¯ä»¥è®¿é—®å¯„å­˜å™¨ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>register long rsp asm ("rsp");
register long rbp asm ("rbp");
</code></pre></div></div>

<p>å®Œæ•´ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;

void func1(void)
{
	int a;
	int b;
	int c;
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	a = 98;
	b = 972;
	c = a + b;
	printf("a = %d, b = %d, c = %d\n", a, b, c);
	printf("func1, rpb = %lx\n", rbp);
	printf("func1, rsp = %lx\n", rsp);
	printf("func1, a = %d\n", *(int *)(((char *)rbp) - 0xc) );
	printf("func1, b = %d\n", *(int *)(((char *)rbp) - 0x8) );
	printf("func1, c = %d\n", *(int *)(((char *)rbp) - 0x4) );
	printf("func1, previous rbp value = %lx\n", *(unsigned long int *)rbp );
	printf("func1, return address value = %lx\n", *(unsigned long int *)((char *)rbp + 8) );
}

void func2(void)
{
	int a;
	int b;
	int c;
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	printf("func2, a = %d, b = %d, c = %d\n", a, b, c);
	printf("func2, rpb = %lx\n", rbp);
	printf("func2, rsp = %lx\n", rsp);
}

int main(void)
{
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	printf("main, rpb = %lx\n", rbp);
	printf("main, rsp = %lx\n", rsp);
	func1();
	func2();
	return (0);
}
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„ç« èŠ‚æˆ‘ä»¬äº†è§£åˆ°ï¼Œ<code class="highlighter-rouge">func1</code>çš„æ ˆå¸§å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="http://data.coderhuo.tech/blog/virtual_memory/stack/func1_stack.png" alt="func1çš„æ ˆå¸§" /></p>

<h3 id="1è®¿é—®å±€éƒ¨å˜é‡">1ã€è®¿é—®å±€éƒ¨å˜é‡</h3>

<p>æ ¹æ®å‰é¢çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“å±€éƒ¨å˜é‡å’Œå¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="highlighter-rouge">a</code>ä½äº<code class="highlighter-rouge">rbp - 0xc</code>æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸ</li>
  <li><code class="highlighter-rouge">b</code>ä½äº<code class="highlighter-rouge">rbp - 0x8</code>æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸ</li>
  <li><code class="highlighter-rouge">c</code>ä½äº<code class="highlighter-rouge">rbp - 0x4</code>æ‰€æŒ‡çš„å†…å­˜åŒºåŸŸ</li>
</ul>

<p>ä¸‹é¢ä»‹ç»å¦‚ä½•é€šè¿‡å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>è·å–å˜é‡<code class="highlighter-rouge">a</code>çš„å€¼ï¼š</p>

<ul>
  <li>å°†å±€éƒ¨å˜é‡<code class="highlighter-rouge">rbp</code>è½¬åŒ–ä¸ºç±»å‹<code class="highlighter-rouge">char *</code>ï¼š<code class="highlighter-rouge">(char *)rbp</code></li>
  <li>è®¡ç®—å˜é‡<code class="highlighter-rouge">a</code>åœ¨å†…å­˜ä¸­çš„ä½ç½®ï¼š<code class="highlighter-rouge">(char *)rbp) - 0xc</code></li>
  <li>å°†ä¸Šä¸€æ­¥çš„æ•°å€¼è½¬æ¢ä¸º<code class="highlighter-rouge">int</code>ç±»å‹çš„æŒ‡é’ˆï¼Œå› ä¸ºå˜é‡<code class="highlighter-rouge">a</code>æ˜¯<code class="highlighter-rouge">int</code>ç±»å‹çš„ï¼š<code class="highlighter-rouge">(int *)(((char *)rbp) - 0xc)</code></li>
  <li>ä»ä¸Šä¸€æ­¥çš„å†…å­˜åœ°å€ä¸­è§£ææ•°å€¼ï¼Œè¯¥å€¼å³ä¸ºå˜é‡<code class="highlighter-rouge">a</code>çš„æ•°å€¼: <code class="highlighter-rouge">*(int *)(((char *)rbp) - 0xc)</code></li>
</ul>

<h3 id="2è®¿é—®å¯„å­˜å™¨rbpçš„å†å²å€¼">2ã€è®¿é—®å¯„å­˜å™¨rbpçš„å†å²å€¼</h3>

<p>ä»<code class="highlighter-rouge">func1</code>çš„æ ˆå¸§ç¤ºæ„å›¾å¯ä»¥çœ‹å‡ºï¼Œå¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>ç›´æ¥æŒ‡å‘å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>å†å²å€¼çš„å­˜å‚¨åŒºåŸŸã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†å˜é‡<code class="highlighter-rouge">rsp</code>è½¬æ¢ä¸º<code class="highlighter-rouge">unsigned long int</code>ç±»å‹çš„æŒ‡é’ˆï¼Œå¹¶è§£æè¯¥æŒ‡é’ˆæŒ‡å‘å†…å­˜åŒºåŸŸçš„å€¼å³å¯ï¼š<code class="highlighter-rouge">*(unsigned long int *)rbp</code>ã€‚</p>

<h3 id="3è®¿é—®å‡½æ•°è¿”å›åœ°å€">3ã€è®¿é—®å‡½æ•°è¿”å›åœ°å€</h3>

<p>ä»<code class="highlighter-rouge">func1</code>çš„æ ˆå¸§ç¤ºæ„å›¾å¯ä»¥çœ‹å‡ºï¼Œå‡½æ•¸è¿”å›åœ°å€å­˜å‚¨åœ¨å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>å†å²å€¼çš„å‰é¢ã€‚å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>çš„å†å²å€¼å ç”¨8å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å˜é‡<code class="highlighter-rouge">rbp</code>çš„å½“å‰å€¼åŠ 8ï¼Œå¾—åˆ°è¿”å›åœ°å€æ‰€åœ¨å†…å­˜çš„åœ°å€ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>

<ul>
  <li>å°†å±€éƒ¨å˜é‡<code class="highlighter-rouge">rbp</code>è½¬åŒ–ä¸ºç±»å‹<code class="highlighter-rouge">char *</code>ï¼š<code class="highlighter-rouge">(char *)rbp</code></li>
  <li>å°†å˜é‡<code class="highlighter-rouge">rbp</code>çš„å€¼åŠ 8ï¼š<code class="highlighter-rouge">((char *)rbp + 8)</code></li>
  <li>å°†ä¸Šä¸€æ­¥çš„æ•°å€¼è½¬æ¢ä¸º<code class="highlighter-rouge">unsigned long int</code>ç±»å‹çš„æŒ‡é’ˆï¼š<code class="highlighter-rouge">(unsigned long int *)(((char *)rbp) + 8)</code></li>
  <li>ä»ä¸Šä¸€æ­¥çš„å†…å­˜åœ°å€ä¸­è§£ææ•°å€¼ï¼Œè¯¥å€¼å³å‡½æ•°è¿”å›åœ°å€: <code class="highlighter-rouge">*(unsigned long int *)((char *)rbp + 8)</code></li>
</ul>

<h3 id="4ç¨‹åºæ‰§è¡Œç»“æœ">4ã€ç¨‹åºæ‰§è¡Œç»“æœ</h3>

<p>ä¸Šé¢ç¨‹åºçš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ gcc 2-main.c &amp;&amp; ./a.out 
main, rpb = 7ffc78e71b70
main, rsp = 7ffc78e71b70
a = 98, b = 972, c = 1070
func1, rpb = 7ffc78e71b60
func1, rsp = 7ffc78e71b50
func1, a = 98
func1, b = 972
func1, c = 1070
func1, previous rbp value = 7ffc78e71b70
func1, return address value = 400697
func2, a = 98, b = 972, c = 1070
func2, rpb = 7ffc78e71b60
func2, rsp = 7ffc78e71b50
holberton$
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š</p>

<ul>
  <li>åœ¨å‡½æ•°<code class="highlighter-rouge">func1</code>ä¸­æˆ‘ä»¬é€šè¿‡å¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>æ­£ç¡®è®¿é—®äº†æ‰€æœ‰çš„å±€éƒ¨å˜é‡</li>
  <li>åœ¨å‡½æ•°<code class="highlighter-rouge">func1</code>ä¸­æˆ‘ä»¬è·å–äº†<code class="highlighter-rouge">main</code>å‡½æ•°æ ˆå¸§çš„<code class="highlighter-rouge">rbp</code>å€¼ï¼ˆå¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>çš„å†å²å€¼ï¼‰</li>
  <li>å‡½æ•°<code class="highlighter-rouge">func1</code>å’Œ<code class="highlighter-rouge">func2</code>æ‹¥æœ‰ç›¸åŒçš„<code class="highlighter-rouge">rbp</code>å’Œ<code class="highlighter-rouge">rsp</code>å€¼(å®ƒä»¬çš„æ ˆå¸§æ˜¯ç›¸åŒçš„ï¼‰</li>
  <li>ä»<code class="highlighter-rouge">func1</code>çš„æ±‡ç¼–ä»£ç <code class="highlighter-rouge">sub rsp,0x10</code>å¯ä»¥çœ‹å‡ºï¼Œå¯„å­˜å™¨<code class="highlighter-rouge">rbp</code>å’Œ<code class="highlighter-rouge">rsp</code>çš„å·®å€¼æ˜¯<code class="highlighter-rouge">0x10</code></li>
  <li>åœ¨<code class="highlighter-rouge">main</code>å‡½æ•°ä¸­<code class="highlighter-rouge">rbp</code>å’Œ<code class="highlighter-rouge">rsp</code>çš„å€¼ç›¸åŒï¼Œå› ä¸º<code class="highlighter-rouge">main</code>æ— å±€éƒ¨å˜é‡</li>
</ul>

<p>ä»ç¨‹åºè¿è¡Œç»“æœçœ‹ï¼Œ<code class="highlighter-rouge">func1</code>æ‰§è¡Œå®Œæ¯•çš„è¿”å›åœ°å€æ˜¯<code class="highlighter-rouge">0x400697</code>ã€‚æˆ‘ä»¬é€šè¿‡æ±‡ç¼–ä»£ç ç¡®è®¤ä¸‹è¯¥å€¼æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœè¯¥å€¼æ˜¯å¯¹çš„ï¼Œè¿™ä¸ªåœ°å€åº”è¯¥æ˜¯<code class="highlighter-rouge">main</code>å‡½æ•°ä¸­ç´§æŒ¨ç€<code class="highlighter-rouge">func1</code>çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>

<p>é¦–å…ˆåæ±‡ç¼–è¯¥å¯æ‰§è¡Œç¨‹åºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ objdump -d -j .text -M intel a.out | less
</code></pre></div></div>

<p><code class="highlighter-rouge">main</code>å‡½æ•°å¯¹åº”çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0000000000400664 &lt;main&gt;:
  400664:       55                      push   rbp
  400665:       48 89 e5                mov    rbp,rsp
  400668:       48 89 e8                mov    rax,rbp
  40066b:       48 89 c6                mov    rsi,rax
  40066e:       bf 3b 08 40 00          mov    edi,0x40083b
  400673:       b8 00 00 00 00          mov    eax,0x0
  400678:       e8 93 fd ff ff          call   400410 &lt;printf@plt&gt;
  40067d:       48 89 e0                mov    rax,rsp
  400680:       48 89 c6                mov    rsi,rax
  400683:       bf 4c 08 40 00          mov    edi,0x40084c
  400688:       b8 00 00 00 00          mov    eax,0x0
  40068d:       e8 7e fd ff ff          call   400410 &lt;printf@plt&gt;
  400692:       e8 96 fe ff ff          call   40052d &lt;func1&gt;
  400697:       e8 7a ff ff ff          call   400616 &lt;func2&gt;
  40069c:       b8 00 00 00 00          mov    eax,0x0
  4006a1:       5d                      pop    rbp
  4006a2:       c3                      ret    
  4006a3:       66 2e 0f 1f 84 00 00    nop    WORD PTR cs:[rax+rax*1+0x0]
  4006aa:       00 00 00 
  4006ad:       0f 1f 00                nop    DWORD PTR [rax]
</code></pre></div></div>

<p>å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬çš„çŒœæµ‹æ˜¯æ­£ç¡®çš„ï¼Œ<code class="highlighter-rouge">0x400697</code>æ˜¯ç´§æŒ¨ç€<code class="highlighter-rouge">func1</code>çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚</p>

<h2 id="ä¸ƒæ ˆå…¥ä¾µ">ä¸ƒã€æ ˆå…¥ä¾µ</h2>

<p>æ—¢ç„¶æˆ‘ä»¬å·²ç»çŸ¥é“å‡½æ•°è¿”å›åœ°å€åœ¨æ ˆä¸Šçš„ä½ç½®ï¼Œå¦‚æœæˆ‘ä»¬ä¿®æ”¹äº†è¿™ä¸ªå€¼ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿ</p>

<p>æˆ‘ä»¬æ˜¯å¦å¯ä»¥æ”¹å˜ç¨‹åºçš„æ‰§è¡Œæµç¨‹ï¼Œè®©<code class="highlighter-rouge">func1</code>æ‰§è¡Œå®Œæ¯•è¿”å›åˆ°å…¶ä»–åœ°æ–¹ï¼Ÿ</p>

<p>åœ¨ä¸Šé¢ä»£ç çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ªæ–°å‡½æ•°<code class="highlighter-rouge">bye</code>ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

void bye(void)
{
	printf("[x] I am in the function bye!\n");
	exit(98);
}

void func1(void)
{
	int a;
	int b;
	int c;
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	a = 98;
	b = 972;
	c = a + b;
	printf("a = %d, b = %d, c = %d\n", a, b, c);
	printf("func1, rpb = %lx\n", rbp);
	printf("func1, rsp = %lx\n", rsp);
	printf("func1, a = %d\n", *(int *)(((char *)rbp) - 0xc) );
	printf("func1, b = %d\n", *(int *)(((char *)rbp) - 0x8) );
	printf("func1, c = %d\n", *(int *)(((char *)rbp) - 0x4) );
	printf("func1, previous rbp value = %lx\n", *(unsigned long int *)rbp );
	printf("func1, return address value = %lx\n", *(unsigned long int *)((char *)rbp + 8) );
}

void func2(void)
{
	int a;
	int b;
	int c;
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	printf("func2, a = %d, b = %d, c = %d\n", a, b, c);
	printf("func2, rpb = %lx\n", rbp);
	printf("func2, rsp = %lx\n", rsp);
}

int main(void)
{
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	printf("main, rpb = %lx\n", rbp);
	printf("main, rsp = %lx\n", rsp);
	func1();
	func2();
	return (0);
}
</code></pre></div></div>

<p>æˆ‘ä»¬çœ‹ä¸‹<code class="highlighter-rouge">bye</code>å‡½æ•°çš„èµ·å§‹åœ°å€ï¼Œé¦–å…ˆåæ±‡ç¼–ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ gcc 3-main.c &amp;&amp; objdump -d -j .text -M intel a.out | less
</code></pre></div></div>

<p>å‡½æ•°<code class="highlighter-rouge">bye</code>çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>00000000004005bd &lt;bye&gt;:
  4005bd:       55                      push   rbp
  4005be:       48 89 e5                mov    rbp,rsp
  4005c1:       bf d8 07 40 00          mov    edi,0x4007d8
  4005c6:       e8 b5 fe ff ff          call   400480 &lt;puts@plt&gt;
  4005cb:       bf 62 00 00 00          mov    edi,0x62
  4005d0:       e8 eb fe ff ff          call   4004c0 &lt;exit@plt&gt;
</code></pre></div></div>

<p>ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨å‡½æ•°<code class="highlighter-rouge">func1</code>ä¸­æŠŠè¿”å›åœ°å€æ›¿æ¢æˆå‡½æ•°<code class="highlighter-rouge">bye</code>çš„èµ·å§‹åœ°å€<code class="highlighter-rouge">0x4005bd</code>ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

void bye(void)
{
	printf("[x] I am in the function bye!\n");
	exit(98);
}

void func1(void)
{
	int a;
	int b;
	int c;
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	a = 98;
	b = 972;
	c = a + b;
	printf("a = %d, b = %d, c = %d\n", a, b, c);
	printf("func1, rpb = %lx\n", rbp);
	printf("func1, rsp = %lx\n", rsp);
	printf("func1, a = %d\n", *(int *)(((char *)rbp) - 0xc) );
	printf("func1, b = %d\n", *(int *)(((char *)rbp) - 0x8) );
	printf("func1, c = %d\n", *(int *)(((char *)rbp) - 0x4) );
	printf("func1, previous rbp value = %lx\n", *(unsigned long int *)rbp );
	printf("func1, return address value = %lx\n", *(unsigned long int *)((char *)rbp + 8) );
	/* hack the stack! */
	*(unsigned long int *)((char *)rbp + 8) = 0x4005bd;
}

void func2(void)
{
	int a;
	int b;
	int c;
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	printf("func2, a = %d, b = %d, c = %d\n", a, b, c);
	printf("func2, rpb = %lx\n", rbp);
	printf("func2, rsp = %lx\n", rsp);
}

int main(void)
{
	register long rsp asm ("rsp");
	register long rbp asm ("rbp");

	printf("main, rpb = %lx\n", rbp);
	printf("main, rsp = %lx\n", rsp);
	func1();
	func2();
	return (0);
}
</code></pre></div></div>

<p>ç¼–è¯‘è¿è¡Œï¼Œç»“æœå¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>holberton$ gcc 4-main.c &amp;&amp; ./a.out
main, rpb = 7fff62ef1b60
main, rsp = 7fff62ef1b60
a = 98, b = 972, c = 1070
func1, rpb = 7fff62ef1b50
func1, rsp = 7fff62ef1b40
func1, a = 98
func1, b = 972
func1, c = 1070
func1, previous rbp value = 7fff62ef1b60
func1, return address value = 40074d
[x] I am in the function bye!
holberton$ echo $?
98
holberton$ 
</code></pre></div></div>

<p>å¤©å“ªï¼ï¼ï¼å‡½æ•°<code class="highlighter-rouge">bye</code>ç«Ÿç„¶è¢«è°ƒç”¨äº†ï¼Œå°½ç®¡æˆ‘ä»¬åœ¨ä»£ç ä¸­å¹¶æœªè°ƒç”¨è¯¥å‡½æ•°ã€‚</p>

<h2 id="å…«ç»§ç»­é˜…è¯»">å…«ã€ç»§ç»­é˜…è¯»</h2>

<ul>
  <li>ç¬¬ä¸€ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/12/Virtual_Memory_C_strings_proc/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸€ç¯‡:C strings &amp; /proc</a></li>
  <li>ç¬¬äºŒç¯‡:<a href="http://blog.coderhuo.tech/2017/10/15/Virtual_Memory_python_bytes/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬äºŒç¯‡:Python å­—èŠ‚</a></li>
  <li>ç¬¬ä¸‰ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/16/Virtual_Memory_drawing_VM_diagram/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬ä¸‰ç¯‡:ä¸€æ­¥ä¸€æ­¥ç”»è™šæ‹Ÿå†…å­˜å›¾</a></li>
  <li>ç¬¬å››ç¯‡:<a href="http://blog.coderhuo.tech/2017/10/18/Virtual_Memory_malloc_and_heap/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬å››ç¯‡:malloc, heap &amp; the program break</a></li>
  <li>ç¬¬äº”ç¯‡ï¼š<a href="http://blog.coderhuo.tech/2019/08/31/Virtual_Memory_malloc_and_heap_stack_and_register/">è™šæ‹Ÿå†…å­˜æ¢ç©¶ â€“ ç¬¬äº”ç¯‡:The Stack, registers and assembly code</a></li>
</ul>

<h2 id="ä¹åŸæ–‡é“¾æ¥">ä¹ã€åŸæ–‡é“¾æ¥</h2>
<p><a href="https://github.com/holbertonschool/Hack-The-Virtual-Memory/tree/master/04.%20The%20Stack%2C%20registers%20and%20assembly%20code">Hack the virtual memory, chapter 4: the stack, registers and assembly code</a></p>

:ET